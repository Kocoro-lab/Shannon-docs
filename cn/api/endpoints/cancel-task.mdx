---
title: "取消任务"
description: "通过 SDK/gRPC 取消运行中的任务"
---

<Warning>
任务取消**仅通过 Python SDK 和 gRPC 可用**。REST API 目前不支持 `DELETE /api/v1/tasks/{id}` 端点。请使用下面的 SDK 方法。
</Warning>

## 概述

取消正在运行的任务以停止执行并释放资源。取消是优雅的，可能需要几秒钟才能完成。

## SDK 方法签名

### Python SDK (同步)

```python
def cancel(
    self,
    task_id: str,
    reason: Optional[str] = None,
    timeout: Optional[float] = None
) -> bool
```

### Python SDK (异步)

```python
async def cancel(
    self,
    task_id: str,
    reason: Optional[str] = None,
    timeout: Optional[float] = None
) -> bool
```

### 参数

| 参数 | 类型 | 必需 | 描述 |
|-----------|------|----------|-------------|
| `task_id` | string | 是 | 要取消的任务标识符 |
| `reason` | string | 否 | 可选的取消原因 |
| `timeout` | float | 否 | 请求超时时间（秒） |

### 返回值

- **类型**：`bool`
- **值**：取消成功返回 `True`，否则返回 `False`

## 示例

### 基本取消

```python
from shannon import ShannonClient

client = ShannonClient()

# 提交任务
handle = client.submit_task(query="Long running analysis...")

# 取消任务
success = client.cancel(handle.task_id)
print("Task cancelled" if success else "Cancellation failed")
```

### 带原因的取消

```python
from shannon import ShannonClient

client = ShannonClient()

# 带原因取消
success = client.cancel(
    task_id="task-dev-1730000000",
    reason="User requested abort"
)

if success:
    print("Task cancelled successfully")
else:
    print("Failed to cancel task")
```

### 异步取消

```python
from shannon import AsyncShannonClient
import asyncio

async def cancel_task():
    async with AsyncShannonClient() as client:
        # 提交任务
        handle = await client.submit_task(query="Process large dataset...")

        # 在某个条件后取消
        success = await client.cancel(
            task_id=handle.task_id,
            reason="Timeout exceeded"
        )

        return success

# 运行异步函数
result = asyncio.run(cancel_task())
print(f"Cancellation {'succeeded' if result else 'failed'}")
```

## 行为和注意事项

### 优雅取消

取消不是瞬时的。当您调用 `cancel()` 时：

1. 取消请求被发送到 Temporal 工作流
2. 工作流接收取消信号
3. 运行中的智能体完成当前操作
4. 清理资源并将任务状态更新为 `TASK_STATUS_CANCELLED`

此过程通常需要 1-5 秒。

### 部分结果

在执行中途取消的任务可能有部分结果可用。取消后检查任务状态：

```python
# 取消任务
client.cancel(task_id)

# 等待片刻以完成取消
import time
time.sleep(2)

# 检查最终状态
status = client.get_status(task_id)
if status.result:
    print("Partial result:", status.result)
```

### 成本影响

- **取消前消耗的令牌仍然会被计费**
- 检查 `status.metrics.cost_usd` 查看累积成本
- 即使在取消的任务上也会执行预算限制

### 取消失败时

`cancel()` 方法在以下情况返回 `False`：
- 未找到任务 ID
- 任务已完成/失败/取消
- 网络/连接错误

适当处理失败：

```python
from shannon import errors

try:
    success = client.cancel(task_id, reason="User abort")
    if not success:
        print("Task may have already completed")
except errors.TaskNotFoundError:
    print("Task does not exist")
except errors.ConnectionError as e:
    print(f"Connection failed: {e}")
```

## 下一步

<CardGroup cols={2}>
  <Card title="流式事件" icon="stream" href="/cn/api/endpoints/stream-task">
    监控任务执行
  </Card>
  <Card title="列出任务" icon="list" href="/cn/api/endpoints/list-tasks">
    查看所有任务
  </Card>
</CardGroup>
