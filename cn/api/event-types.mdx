---
title: "事件类型目录"
description: "Shannon 流式事件类型的完整参考"
---

## 概述

Shannon 通过服务器发送事件(Server-Sent Events, SSE)发出**实时事件**,以提供任务执行的可见性。本文档记录了**所有 35+ 种事件类型**、它们的结构以及发生时机。

事件提供:
- **实时进度** - 实时跟踪任务执行
- **调试洞察** - LLM 提示词、工具调用、智能体推理
- **成本监控** - 实时跟踪 token 使用量和成本
- **多智能体协调** - 观察团队组建和协作
- **错误恢复** - 监控错误处理和恢复尝试

## 事件结构

所有事件遵循以下基础结构:

```json
{
  "workflow_id": "wf-550e8400-e29b-41d4-a716-446655440000",
  "type": "AGENT_THINKING",
  "agent_id": "agent-001",
  "message": "Analyzing task complexity...",
  "timestamp": "2024-10-27T10:00:00Z",
  "seq": 42,
  "stream_id": "stream-abc123",
  "data": {}
}
```

### 基础字段

| 字段 | 类型 | 描述 |
|-------|------|-------------|
| `workflow_id` | string | 唯一的任务/工作流标识符 |
| `type` | string | 事件类型(参见下面的目录) |
| `agent_id` | string | 发出事件的智能体 |
| `message` | string | 人类可读的事件描述 |
| `timestamp` | ISO 8601 | 事件发生时间 |
| `seq` | integer | 用于排序的序列号 |
| `stream_id` | string | 用于重连的流标识符 |
| `data` | object | 事件特定的载荷(可选) |

---

## 事件分类

事件被组织为逻辑分类:

1. **工作流事件** - 任务生命周期
2. **智能体事件** - 智能体执行
3. **工具事件** - 工具调用
4. **模式事件** - 认知模式执行
5. **团队事件** - 多智能体协调
6. **LLM 事件** - 语言模型交互
7. **进度事件** - 任务进度和状态
8. **系统事件** - 错误和系统状态

---

## 事件类型快速参考

按分类列出的所有事件类型完整列表:

| 事件类型 | 分类 | 描述 |
|------------|----------|-------------|
| `WORKFLOW_STARTED` | 工作流 | 任务开始执行 |
| `WORKFLOW_COMPLETED` | 工作流 | 任务成功完成 |
| `WORKFLOW_FAILED` | 工作流 | 任务失败并出错 |
| `AGENT_STARTED` | 智能体 | 智能体开始处理 |
| `AGENT_THINKING` | 智能体 | 智能体推理/规划 |
| `AGENT_COMPLETED` | 智能体 | 智能体成功完成 |
| `AGENT_FAILED` | 智能体 | 智能体遇到错误 |
| `TOOL_INVOKED` | 工具 | 调用工具 |
| `TOOL_COMPLETED` | 工具 | 工具执行完成 |
| `TOOL_FAILED` | 工具 | 工具执行失败 |
| `TOOL_OBSERVATION` | 工具 | 智能体观察工具结果 |
| `PATTERN_SELECTED` | 模式 | 选择认知模式 |
| `TASK_DECOMPOSED` | 模式 | 任务分解为子任务 |
| `SUBTASK_STARTED` | 模式 | 单个子任务开始 |
| `SUBTASK_COMPLETED` | 模式 | 子任务完成 |
| `TEAM_RECRUITED` | 团队 | 组建多智能体团队 |
| `TEAM_RETIRED` | 团队 | 解散团队 |
| `TEAM_STATUS` | 团队 | 团队协调更新 |
| `DEPENDENCY_SATISFIED` | 团队 | 依赖关系已解决 |
| `MESSAGE_SENT` | 消息 | 智能体发送消息 |
| `MESSAGE_RECEIVED` | 消息 | 智能体接收消息 |
| `LLM_PROMPT` | LLM | 提示词发送到 LLM |
| `LLM_PARTIAL` | LLM | 增量 LLM 输出 |
| `LLM_OUTPUT` | LLM | 最终 LLM 输出 |
| `PROGRESS` | 进度 | 通用进度更新 |
| `DATA_PROCESSING` | 进度 | 处理/分析数据 |
| `WAITING` | 进度 | 等待资源 |
| `ERROR_OCCURRED` | 系统 | 系统错误 |
| `ERROR_RECOVERY` | 系统 | 错误恢复尝试 |
| `BUDGET_UPDATE` | 系统 | 成本/token 更新 |
| `APPROVAL_REQUESTED` | 系统 | 需要人工批准 |
| `APPROVAL_DECISION` | 系统 | 批准决策已做出 |
| `WORKSPACE_UPDATED` | 系统 | 内存/上下文已更新 |
| `ROLE_ASSIGNED` | 系统 | 智能体角色已分配 |
| `DELEGATION` | 系统 | 任务已委托 |

**总计**: 35 种事件类型

---

## 工作流事件

与整体任务工作流相关的事件。

### WORKFLOW_STARTED

**发出时机**: 任务开始执行时

**数据**:
```json
{
  "type": "WORKFLOW_STARTED",
  "message": "Workflow started",
  "data": {
    "query": "Analyze Q4 sales data",
    "mode": "STANDARD",
    "session_id": "sess-123",
    "estimated_complexity": 0.75
  }
}
```

**字段**:
- `query`: 原始任务查询
- `mode`: 执行模式(SIMPLE、STANDARD、COMPLEX)
- `session_id`: 会话标识符
- `estimated_complexity`: 复杂度分数(0.0-1.0)

---

### WORKFLOW_COMPLETED

**发出时机**: 任务成功完成时

**数据**:
```json
{
  "type": "WORKFLOW_COMPLETED",
  "message": "Workflow completed successfully",
  "data": {
    "result": "Analysis complete. Key findings: ...",
    "duration_ms": 45000,
    "total_tokens": 5420,
    "total_cost_usd": 0.0814,
    "agents_used": 3,
    "tools_invoked": 7
  }
}
```

**字段**:
- `result`: 最终任务结果
- `duration_ms`: 总执行时间
- `total_tokens`: 累计 token 使用量
- `total_cost_usd`: 总成本
- `agents_used`: 调用的智能体数量
- `tools_invoked`: 工具调用次数

---

### WORKFLOW_FAILED

**发出时机**: 任务失败时

**数据**:
```json
{
  "type": "WORKFLOW_FAILED",
  "message": "Workflow failed: Budget exceeded",
  "data": {
    "error": "BUDGET_EXCEEDED",
    "error_message": "Task exceeded maximum cost of $0.50",
    "duration_ms": 12000,
    "tokens_used": 8000,
    "cost_usd": 0.52
  }
}
```

**常见错误类型**:
- `BUDGET_EXCEEDED` - 达到成本/token 限制
- `TIMEOUT` - 执行超时
- `TOOL_EXECUTION_FAILED` - 工具错误
- `LLM_ERROR` - LLM 提供商错误
- `INVALID_INPUT` - 格式错误的请求

---

## 智能体事件

与单个智能体执行相关的事件。

### AGENT_STARTED

**发出时机**: 智能体开始处理时

**数据**:
```json
{
  "type": "AGENT_STARTED",
  "agent_id": "data-analyst",
  "message": "Agent started",
  "data": {
    "role": "data-analyst",
    "subtask": "Analyze revenue trends",
    "tools_available": ["csv_loader", "pandas", "matplotlib"]
  }
}
```

---

### AGENT_THINKING

**发出时机**: 智能体正在推理/处理(最频繁的事件)

**数据**:
```json
{
  "type": "AGENT_THINKING",
  "agent_id": "data-analyst",
  "message": "Analyzing data structure...",
  "data": {
    "thought": "I need to first load the CSV and examine column types",
    "next_action": "invoke_tool",
    "confidence": 0.85
  }
}
```

**用途**: 作为进度指示器显示给用户

---

### AGENT_COMPLETED

**发出时机**: 智能体完成其子任务时

**数据**:
```json
{
  "type": "AGENT_COMPLETED",
  "agent_id": "data-analyst",
  "message": "Agent completed successfully",
  "data": {
    "result": "Revenue increased 15% YoY",
    "tokens_used": 1200,
    "cost_usd": 0.018,
    "duration_ms": 8000
  }
}
```

---

### AGENT_FAILED

**发出时机**: 智能体遇到错误时

**数据**:
```json
{
  "type": "AGENT_FAILED",
  "agent_id": "data-analyst",
  "message": "Agent failed: Tool execution error",
  "data": {
    "error": "TOOL_EXECUTION_FAILED",
    "error_message": "CSV file not found",
    "recoverable": true
  }
}
```

---

## 工具事件

与工具调用相关的事件。

### TOOL_INVOKED

**发出时机**: 调用工具时

**数据**:
```json
{
  "type": "TOOL_INVOKED",
  "message": "Invoking tool: csv_loader",
  "data": {
    "tool_name": "csv_loader",
    "tool_args": {
      "file_path": "sales_q4.csv"
    },
    "timeout_seconds": 30
  }
}
```

---

### TOOL_COMPLETED

**发出时机**: 工具执行完成时

**数据**:
```json
{
  "type": "TOOL_COMPLETED",
  "message": "Tool completed: csv_loader",
  "data": {
    "tool_name": "csv_loader",
    "result": {
      "rows": 15000,
      "columns": 12,
      "sample": ["date", "product", "revenue", "..."]
    },
    "duration_ms": 450,
    "cached": false
  }
}
```

---

### TOOL_FAILED

**发出时机**: 工具执行失败时

**数据**:
```json
{
  "type": "TOOL_FAILED",
  "message": "Tool failed: web_search",
  "data": {
    "tool_name": "web_search",
    "error": "RATE_LIMIT_EXCEEDED",
    "error_message": "Search API rate limit reached",
    "retry_after_seconds": 60
  }
}
```

---

## 模式事件

特定于认知模式执行的事件。

### PATTERN_SELECTED

**发出时机**: 选择认知模式时

**数据**:
```json
{
  "type": "PATTERN_SELECTED",
  "message": "Selected pattern: Tree-of-Thoughts",
  "data": {
    "pattern": "TREE_OF_THOUGHTS",
    "reason": "Task requires exploration of multiple solution paths",
    "complexity": 0.82,
    "estimated_cost_usd": 0.45
  }
}
```

**可用模式**:
- `CHAIN_OF_THOUGHT` - 顺序推理
- `TREE_OF_THOUGHTS` - 分支探索
- `REACT` - 推理 + 行动循环
- `DEBATE` - 多视角分析
- `REFLECTION` - 自我改进循环

---

### TASK_DECOMPOSED

**发出时机**: 任务分解为子任务时

**数据**:
```json
{
  "type": "TASK_DECOMPOSED",
  "message": "Task decomposed into 4 subtasks",
  "data": {
    "strategy": "DAG",
    "subtasks": [
      {
        "id": "subtask-1",
        "description": "Load data",
        "dependencies": []
      },
      {
        "id": "subtask-2",
        "description": "Calculate statistics",
        "dependencies": ["subtask-1"]
      },
      {
        "id": "subtask-3",
        "description": "Create visualizations",
        "dependencies": ["subtask-2"]
      },
      {
        "id": "subtask-4",
        "description": "Generate report",
        "dependencies": ["subtask-2", "subtask-3"]
      }
    ]
  }
}
```

---

### SUBTASK_STARTED

**发出时机**: 单个子任务开始时

**数据**:
```json
{
  "type": "SUBTASK_STARTED",
  "message": "Starting subtask: Load data",
  "data": {
    "subtask_id": "subtask-1",
    "description": "Load Q4 sales data",
    "assigned_agent": "data-loader"
  }
}
```

---

### SUBTASK_COMPLETED

**发出时机**: 子任务完成时

**数据**:
```json
{
  "type": "SUBTASK_COMPLETED",
  "message": "Subtask completed: Load data",
  "data": {
    "subtask_id": "subtask-1",
    "result": "Loaded 15,000 records",
    "duration_ms": 2000,
    "tokens_used": 150
  }
}
```

---

## 团队事件

多智能体团队协调和管理。

### TEAM_RECRUITED

**发出时机**: 组建智能体团队进行执行时

**数据**:
```json
{
  "type": "TEAM_RECRUITED",
  "message": "Team recruited: 3 agents",
  "data": {
    "team_size": 3,
    "agents": [
      {
        "agent_id": "data-analyst",
        "role": "analyst",
        "capabilities": ["data_loading", "analysis"]
      },
      {
        "agent_id": "visualizer",
        "role": "visualization",
        "capabilities": ["charts", "graphs"]
      },
      {
        "agent_id": "writer",
        "role": "report_generation",
        "capabilities": ["summarization", "writing"]
      }
    ]
  }
}
```

---

### TEAM_RETIRED

**发出时机**: 任务完成后解散团队时

**数据**:
```json
{
  "type": "TEAM_RETIRED",
  "message": "Team retired after task completion",
  "data": {
    "team_size": 3,
    "duration_ms": 45000,
    "total_tokens": 8000,
    "reason": "task_completed"
  }
}
```

---

### TEAM_STATUS

**发出时机**: 多智能体团队协调的定期更新

**数据**:
```json
{
  "type": "TEAM_STATUS",
  "message": "Team progress update",
  "data": {
    "active_agents": 2,
    "idle_agents": 1,
    "tasks_completed": 5,
    "tasks_remaining": 3,
    "coordination_mode": "parallel"
  }
}
```

---

### DEPENDENCY_SATISFIED

**发出时机**: 任务依赖关系已解决且可以继续执行时

**数据**:
```json
{
  "type": "DEPENDENCY_SATISFIED",
  "message": "Dependencies satisfied for subtask-3",
  "data": {
    "subtask_id": "subtask-3",
    "satisfied_dependencies": ["subtask-1", "subtask-2"],
    "can_proceed": true
  }
}
```

---

## 消息事件

智能体之间的通信。

### MESSAGE_SENT

**发出时机**: 智能体向另一个智能体发送消息时

**数据**:
```json
{
  "type": "MESSAGE_SENT",
  "agent_id": "supervisor",
  "message": "Message sent to data-analyst",
  "data": {
    "to": "data-analyst",
    "content": "Please analyze revenue trends",
    "message_type": "DELEGATION"
  }
}
```

---

### MESSAGE_RECEIVED

**发出时机**: 智能体接收消息时

**数据**:
```json
{
  "type": "MESSAGE_RECEIVED",
  "agent_id": "data-analyst",
  "message": "Message received from supervisor",
  "data": {
    "from": "supervisor",
    "content": "Please analyze revenue trends",
    "acknowledged": true
  }
}
```

---

## LLM 事件

用于调试和监控的语言模型交互事件。

### LLM_PROMPT

**发出时机**: 提示词发送到 LLM 时(为保护隐私已脱敏)

**数据**:
```json
{
  "type": "LLM_PROMPT",
  "message": "Sending prompt to LLM",
  "data": {
    "model": "gpt-4",
    "prompt_length": 1200,
    "max_tokens": 2000,
    "temperature": 0.7,
    "sanitized_prompt": "Analyze the provided data..."
  }
}
```

---

### LLM_PARTIAL

**发出时机**: 流式传输期间的增量 LLM 输出块

**数据**:
```json
{
  "type": "LLM_PARTIAL",
  "message": "Received partial LLM output",
  "data": {
    "chunk": "Based on the analysis",
    "chunk_index": 5,
    "total_tokens_so_far": 50
  }
}
```

---

### LLM_OUTPUT

**发出时机**: 某个步骤的最终 LLM 输出

**数据**:
```json
{
  "type": "LLM_OUTPUT",
  "message": "LLM output complete",
  "data": {
    "output": "Analysis complete. Revenue increased 15% YoY...",
    "model": "gpt-4",
    "tokens_used": 350,
    "cost_usd": 0.0105,
    "duration_ms": 2000
  }
}
```

---

### TOOL_OBSERVATION

**发出时机**: 智能体观察工具结果时

**数据**:
```json
{
  "type": "TOOL_OBSERVATION",
  "message": "Agent observed tool result",
  "data": {
    "tool_name": "web_search",
    "observation": "Found 10 relevant results about AI trends",
    "relevance_score": 0.85
  }
}
```

---

## 进度事件

用于用户反馈的任务进度和状态更新。

### PROGRESS

**发出时机**: 执行期间的通用进度更新

**数据**:
```json
{
  "type": "PROGRESS",
  "message": "Progress: 60% complete",
  "data": {
    "percentage": 60,
    "current_step": 3,
    "total_steps": 5,
    "current_task": "Generating visualizations"
  }
}
```

---

### DATA_PROCESSING

**发出时机**: 智能体正在处理或分析数据时

**数据**:
```json
{
  "type": "DATA_PROCESSING",
  "message": "Processing sales data",
  "data": {
    "operation": "data_analysis",
    "records_processed": 15000,
    "total_records": 15000,
    "processing_stage": "aggregation"
  }
}
```

---

### WAITING

**发出时机**: 智能体正在等待资源或响应时

**数据**:
```json
{
  "type": "WAITING",
  "message": "Waiting for dependencies",
  "data": {
    "waiting_for": "subtask-2",
    "wait_reason": "dependency_not_satisfied",
    "estimated_wait_seconds": 10
  }
}
```

---

## 系统事件

系统级事件和错误。

### ERROR_OCCURRED

**发出时机**: 执行期间发生系统错误时

**数据**:
```json
{
  "type": "ERROR_OCCURRED",
  "message": "Database connection failed",
  "data": {
    "error_type": "DATABASE_ERROR",
    "error_message": "Connection timeout",
    "recoverable": true,
    "retry_count": 2,
    "max_retries": 3
  }
}
```

---

### BUDGET_UPDATE

**发出时机**: 执行期间定期更新以跟踪成本

**数据**:
```json
{
  "type": "BUDGET_UPDATE",
  "message": "Budget status update",
  "data": {
    "tokens_used": 3200,
    "tokens_limit": 10000,
    "cost_usd": 0.048,
    "cost_limit_usd": 0.50,
    "percentage_used": 9.6
  }
}
```

---

### ERROR_RECOVERY

**发出时机**: 系统正在从错误中恢复时

**数据**:
```json
{
  "type": "ERROR_RECOVERY",
  "message": "Recovering from database connection error",
  "data": {
    "error_type": "DATABASE_ERROR",
    "recovery_action": "retry_connection",
    "attempt": 2,
    "max_attempts": 3,
    "success": true
  }
}
```

---

### APPROVAL_REQUESTED

**发出时机**: 需要人工批准才能继续时

**数据**:
```json
{
  "type": "APPROVAL_REQUESTED",
  "message": "Approval requested for file system access",
  "data": {
    "approval_id": "appr-123",
    "tool_name": "file_system",
    "operation": "write",
    "risk_level": "HIGH",
    "timeout_seconds": 7200,
    "details": {
      "file_path": "/data/critical.db",
      "action": "delete"
    }
  }
}
```

---

### APPROVAL_DECISION

**发出时机**: 人工做出批准决策时

**数据**:
```json
{
  "type": "APPROVAL_DECISION",
  "message": "Approval granted",
  "data": {
    "approval_id": "appr-123",
    "decision": "approved",
    "approved_by": "user-456",
    "timestamp": "2024-10-27T10:05:00Z",
    "comments": "Verified action is necessary"
  }
}
```

**决策值**:
- `approved` - 允许操作继续
- `denied` - 阻止操作
- `timeout` - 超时期间内未做决策

---

### WORKSPACE_UPDATED

**发出时机**: 工作内存/上下文更新时

**数据**:
```json
{
  "type": "WORKSPACE_UPDATED",
  "message": "Workspace updated",
  "data": {
    "key": "loaded_datasets",
    "value": ["sales_q4.csv"],
    "action": "ADD"
  }
}
```

---

### ROLE_ASSIGNED

**发出时机**: 执行期间分配智能体角色时

**数据**:
```json
{
  "type": "ROLE_ASSIGNED",
  "agent_id": "agent-002",
  "message": "Role assigned: data-analyst",
  "data": {
    "role": "data-analyst",
    "capabilities": ["data_loading", "analysis", "visualization"],
    "tools": ["csv_loader", "pandas", "matplotlib"]
  }
}
```

---

### DELEGATION

**发出时机**: 任务委托给另一个智能体时

**数据**:
```json
{
  "type": "DELEGATION",
  "agent_id": "supervisor",
  "message": "Delegated to data-analyst",
  "data": {
    "to_agent": "data-analyst",
    "task": "Analyze revenue trends",
    "priority": "HIGH"
  }
}
```

---

## 事件排序

事件按序列号(`seq`)**严格排序**:

```json
{"seq": 1, "type": "WORKFLOW_STARTED"}
{"seq": 2, "type": "PATTERN_SELECTED"}
{"seq": 3, "type": "TASK_DECOMPOSED"}
{"seq": 4, "type": "SUBTASK_STARTED"}
{"seq": 5, "type": "AGENT_STARTED"}
{"seq": 6, "type": "AGENT_THINKING"}
{"seq": 7, "type": "TOOL_INVOKED"}
{"seq": 8, "type": "TOOL_COMPLETED"}
{"seq": 42, "type": "WORKFLOW_COMPLETED"}
```

**特性**:
- 序列号单调递增
- 序列中无间隙(从 1 到 N 的每个数字)
- 来自同一工作流的事件始终正确排序

---

## 典型事件流程

### 简单任务(SIMPLE 模式)

```
1. WORKFLOW_STARTED
2. AGENT_STARTED
3. AGENT_THINKING
4. TOOL_INVOKED (如果需要)
5. TOOL_COMPLETED
6. AGENT_COMPLETED
7. WORKFLOW_COMPLETED
```

### 标准任务(STANDARD 模式)

```
1. WORKFLOW_STARTED
2. PATTERN_SELECTED
3. TASK_DECOMPOSED
4. SUBTASK_STARTED (子任务 1)
5. AGENT_STARTED
6. AGENT_THINKING
7. TOOL_INVOKED
8. TOOL_COMPLETED
9. AGENT_COMPLETED
10. SUBTASK_COMPLETED (子任务 1)
11. SUBTASK_STARTED (子任务 2)
12. ... (对每个子任务重复)
N. WORKFLOW_COMPLETED
```

### 复杂任务(COMPLEX 模式)

```
1. WORKFLOW_STARTED
2. PATTERN_SELECTED (Tree-of-Thoughts)
3. TASK_DECOMPOSED
4. TEAM_RECRUITED (多智能体团队)
5. 多个并行的 SUBTASK_STARTED
6. AGENT_THINKING (探索阶段)
7. 多个 AGENT_STARTED (并行智能体)
8. ROLE_ASSIGNED (智能体获得专门角色)
9. DATA_PROCESSING (智能体工作中)
10. WAITING (等待依赖)
11. DEPENDENCY_SATISFIED (解除执行阻塞)
12. LLM_PROMPT / LLM_OUTPUT (LLM 交互)
13. TOOL_INVOKED / TOOL_COMPLETED
14. TOOL_OBSERVATION (智能体处理结果)
15. MESSAGE_SENT / MESSAGE_RECEIVED (智能体协调)
16. DELEGATION (任务交接)
17. TEAM_STATUS (进度更新)
18. PROGRESS (整体进度)
19. 子任务并行完成
20. TEAM_RETIRED (团队解散)
21. WORKFLOW_COMPLETED
```

---

## 流式传输最佳实践

### 进度指示器

```python
# 跟踪进度
total_subtasks = 0
completed_subtasks = 0

for event in client.stream_events(workflow_id):
    if event.type == 'TASK_DECOMPOSED':
        total_subtasks = event.data['subtasks']

    elif event.type == 'SUBTASK_COMPLETED':
        completed_subtasks += 1
        progress = (completed_subtasks / total_subtasks) * 100
        print(f"Progress: {progress:.1f}%")

    elif event.type == 'WORKFLOW_COMPLETED':
        print("Done!")
        break
```

### 成本监控

```python
# 实时监控成本
for event in client.stream_events(workflow_id):
    if event.type == 'BUDGET_UPDATE':
        cost = event.data['cost_usd']
        limit = event.data['cost_limit_usd']

        if cost > limit * 0.8:
            print(f"Warning: 80% of budget used (${cost:.3f}/${limit:.2f})")

    elif event.type == 'WORKFLOW_FAILED':
        if event.data['error'] == 'BUDGET_EXCEEDED':
            print("Task cancelled: Budget exceeded")
```

### 错误处理

```python
# 优雅地处理错误
for event in client.stream_events(workflow_id):
    if event.type == 'ERROR_OCCURRED':
        error = event.data

        if error['recoverable']:
            print(f"Recoverable error: {error['error_message']}")
            print(f"Retry {error['retry_count']}/{error['max_retries']}")
        else:
            print(f"Fatal error: {error['error_message']}")
            break

    elif event.type == 'WORKFLOW_FAILED':
        print(f"Task failed: {event.data['error_message']}")
        break
```

---

## 过滤事件

按类型过滤事件以用于特定用例:

```python
# 仅显示面向用户的事件
USER_EVENTS = {
    'WORKFLOW_STARTED',
    'WORKFLOW_COMPLETED',
    'PATTERN_SELECTED',
    'TASK_DECOMPOSED',
    'TOOL_INVOKED',
    'ERROR_OCCURRED',
    'BUDGET_UPDATE'
}

for event in client.stream_events(workflow_id):
    if event.type in USER_EVENTS:
        print(f"[{event.type}] {event.message}")
```

```python
# 调试模式: 显示所有内容
for event in client.stream_events(workflow_id):
    print(f"[{event.seq}] {event.type}: {event.message}")
    if event.data:
        print(f"  Data: {json.dumps(event.data, indent=2)}")
```

---

## 事件持久化

事件存储在:
- **PostgreSQL**: 永久事件日志
- **Redis**: 最近的事件(热缓存)
- **实时**: SSE 流

**检索历史事件**:
```bash
# 获取任务的所有事件
GET /api/v1/tasks/{task_id}/events?limit=1000
```

---

## 事件可靠性和保证

### 排序保证

Shannon 在单个工作流内提供**严格排序**:
- 事件按顺序编号(`seq` 字段)
- 序列号无间隙(1、2、3、...)
- 来自同一工作流的事件始终按顺序到达
- 来自不同工作流的事件可能会交错

### 交付保证

- **至少一次交付**: 事件可能会被多次交付(使用 `seq` 进行去重)
- **事件持久化**: 所有事件存储在 PostgreSQL `event_logs` 表中
- **热缓存**: 最近的事件缓存在 Redis 中以便快速检索
- **历史访问**: 通过 REST API 查询过去的事件

### 流重连

如果 SSE 连接断开:
```python
# 重连并从最后一个序列号恢复
last_seq = 42  # 最后接收的事件
for event in client.stream_events(workflow_id, from_seq=last_seq + 1):
    process_event(event)
```

### 事件保留期

| 存储 | 保留期 | 用途 |
|---------|-----------------|---------|
| Redis | 1 小时 | 实时流式传输 |
| PostgreSQL | 90 天(默认) | 历史查询 |
| 归档 | 1 年以上(可选) | 长期审计 |

有关事件存储详情,请参见[数据库模式](/cn/architecture/database-schema#event-logs-table)。

---

## 完整事件类型参考

所有 35 种事件类型都已投入生产并由 Shannon 主动发出。以下事件发出最频繁:

**高频**(每个任务多次):
- `AGENT_THINKING` - 智能体推理步骤
- `LLM_PARTIAL` - 流式 LLM 输出
- `DATA_PROCESSING` - 数据处理更新
- `PROGRESS` - 进度更新

**中频**(每个任务少量):
- `TOOL_INVOKED` / `TOOL_COMPLETED` - 工具调用
- `AGENT_STARTED` / `AGENT_COMPLETED` - 智能体生命周期
- `SUBTASK_STARTED` / `SUBTASK_COMPLETED` - 子任务执行

**低频**(每个任务一次):
- `WORKFLOW_STARTED` / `WORKFLOW_COMPLETED` - 工作流生命周期
- `PATTERN_SELECTED` - 模式选择
- `TASK_DECOMPOSED` - 任务分解
- `TEAM_RECRUITED` / `TEAM_RETIRED` - 团队管理

**罕见**(仅在需要时):
- `ERROR_OCCURRED` / `ERROR_RECOVERY` - 错误处理
- `APPROVAL_REQUESTED` / `APPROVAL_DECISION` - 人工批准
- `WORKFLOW_FAILED` / `AGENT_FAILED` / `TOOL_FAILED` - 失败

---

## 相关主题

<CardGroup cols={2}>
  <Card title="流式传输 API" icon="stream" href="/cn/api/rest/streaming">
    SSE 和 WebSocket 流式传输
  </Card>
  <Card title="Python SDK 流式传输" icon="python" href="/cn/sdk/python/streaming">
    SDK 流式传输指南
  </Card>
  <Card title="列出任务" icon="list" href="/cn/api/rest/list-tasks">
    查看任务历史
  </Card>
  <Card title="故障排除" icon="wrench" href="/cn/quickstart/troubleshooting">
    调试流式传输问题
  </Card>
</CardGroup>
