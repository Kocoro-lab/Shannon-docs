---
title: "REST API 概览"
description: "Shannon Gateway 的完整 REST API 参考"
---

## 基础 URL

```
http://localhost:8080
```

对于生产环境部署，请将 `localhost:8080` 替换为您的网关 URL。

## API 端点

Shannon 提供了 11 个 REST API 端点，分为三类：

### 任务管理

| 方法 | 端点 | 描述 | 需要认证 |
|--------|----------|-------------|---------------|
| `POST` | `/api/v1/tasks` | 提交新任务 | 是 |
| `GET` | `/api/v1/tasks` | 列出任务（支持过滤） | 是 |
| `GET` | `/api/v1/tasks/{id}` | 获取任务状态和结果 | 是 |
| `GET` | `/api/v1/tasks/{id}/events` | 获取任务事件历史 | 是 |
| `GET` | `/api/v1/tasks/{id}/timeline` | 获取任务执行时间线 | 是 |

### 流式传输

| 方法 | 端点 | 描述 | 需要认证 |
|--------|----------|-------------|---------------|
| `GET` | `/api/v1/tasks/{id}/stream` | 流式传输任务事件 (SSE) | 是 |
| `GET` | `/api/v1/stream/sse` | Server-Sent Events 端点 | 是 |
| `GET` | `/api/v1/stream/ws` | WebSocket 流式传输端点 | 是 |

### 健康检查与可观测性

| 方法 | 端点 | 描述 | 需要认证 |
|--------|----------|-------------|---------------|
| `GET` | `/health` | 健康检查探针 | 否 |
| `GET` | `/readiness` | 就绪检查探针 | 否 |
| `GET` | `/openapi.json` | OpenAPI 3.0 规范 | 否 |

## 身份认证

所有任务和流式传输端点都需要通过 API 密钥进行身份认证。

### API 密钥请求头

```bash
curl -H "X-API-Key: sk_test_123456" \
  http://localhost:8080/api/v1/tasks
```

### 禁用认证（仅限开发环境）

设置环境变量：

```bash
GATEWAY_SKIP_AUTH=1
```

**警告**：切勿在生产环境中禁用身份认证。

## 通用请求头

### 请求头

| 请求头 | 必需 | 描述 | 示例 |
|--------|----------|-------------|---------|
| `X-API-Key` | 是* | 认证密钥 | `sk_test_123456` |
| `Content-Type` | 是 (POST) | 请求体格式 | `application/json` |
| `Idempotency-Key` | 否 | 防止重复提交 | `550e8400-e29b-41d4-a716-446655440000` |
| `traceparent` | 否 | W3C 追踪上下文 | `00-4bf92f...` |

*如果设置了 `GATEWAY_SKIP_AUTH=1` 则不需要

### 响应头

| 响应头 | 描述 | 示例 |
|--------|-------------|---------|
| `X-Workflow-ID` | Temporal 工作流标识符 | `task_abc123_workflow` |
| `X-Session-ID` | 会话标识符 | `user-123-session` |
| `Content-Type` | 响应格式 | `application/json` |

## 速率限制

速率限制按 API 密钥执行，存储在 Redis 中。

### 速率限制响应头

```bash
X-RateLimit-Limit: 100          # 每个时间窗口的请求数
X-RateLimit-Remaining: 95       # 剩余请求数
X-RateLimit-Reset: 1609459200   # Unix 时间戳
```

### 速率限制错误

**状态码**：`429 Too Many Requests`

```json
{
  "error": "Rate limit exceeded",
  "retry_after": 60
}
```

**默认限制**：
- **标准**：每个 API 密钥 100 请求/分钟
- **突发**：20 请求/秒

通过环境变量配置：
```bash
RATE_LIMIT_RPM=100
RATE_LIMIT_BURST=20
```

## Idempotency

POST requests support idempotency to prevent duplicate task submissions.

### How It Works

1. Generate a unique `Idempotency-Key` (UUIDv4 recommended)
2. Include in request header
3. Shannon caches response for 24 hours
4. Duplicate requests return cached response

### Example

```bash
# First request - creates task
curl -X POST http://localhost:8080/api/v1/tasks \
  -H "X-API-Key: sk_test_123456" \
  -H "Idempotency-Key: 550e8400-e29b-41d4-a716-446655440000" \
  -H "Content-Type: application/json" \
  -d '{"query": "Analyze sales data"}'

# Response: 200 OK
{
  "task_id": "task_abc123",
  "status": "TASK_STATUS_QUEUED"
}

# Duplicate request (same Idempotency-Key) - returns cached
curl -X POST http://localhost:8080/api/v1/tasks \
  -H "X-API-Key: sk_test_123456" \
  -H "Idempotency-Key: 550e8400-e29b-41d4-a716-446655440000" \
  -H "Content-Type: application/json" \
  -d '{"query": "Different query"}'

# Response: 200 OK (same task_id, ignores new query)
{
  "task_id": "task_abc123",
  "status": "TASK_STATUS_QUEUED"
}
```

**Cache Duration**: 24 hours (Redis TTL)

## Error Handling

### Standard Error Response

```json
{
  "error": "Error message describing what went wrong"
}
```

### HTTP Status Codes

| Code | Meaning | Common Causes |
|------|---------|---------------|
| `200` | Success | Request completed successfully |
| `400` | Bad Request | Invalid JSON, missing required fields |
| `401` | Unauthorized | Missing or invalid API key |
| `404` | Not Found | Task ID doesn't exist |
| `429` | Too Many Requests | Rate limit exceeded |
| `500` | Internal Server Error | Server error, check logs |
| `502` | Bad Gateway | Upstream service unavailable |
| `503` | Service Unavailable | System overloaded or maintenance |

### Error Examples

**400 Bad Request**:
```json
{
  "error": "Query is required"
}
```

**401 Unauthorized**:
```json
{
  "error": "Unauthorized"
}
```

**404 Not Found**:
```json
{
  "error": "Task not found"
}
```

**429 Rate Limited**:
```json
{
  "error": "Rate limit exceeded",
  "retry_after": 60
}
```

**500 Internal Server Error**:
```json
{
  "error": "Failed to submit task: database connection failed"
}
```

## Distributed Tracing

Shannon supports W3C Trace Context for distributed tracing.

### Trace Context Header

```bash
curl -H "traceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01" \
  http://localhost:8080/api/v1/tasks
```

### Format

```
traceparent: {version}-{trace-id}-{parent-id}-{trace-flags}
```

- **version**: `00` (current version)
- **trace-id**: 32 hex characters (16 bytes)
- **parent-id**: 16 hex characters (8 bytes)
- **trace-flags**: 2 hex characters (sampled flag)

Traces propagate through:
1. Gateway HTTP handler
2. gRPC calls to Orchestrator
3. Agent Core execution
4. LLM Service requests
5. Temporal workflows

## CORS Configuration

CORS is enabled for development with permissive settings.

### Headers Set

```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization, X-API-Key, Idempotency-Key, traceparent, tracestate
Access-Control-Max-Age: 3600
```

**Production**: Configure `Access-Control-Allow-Origin` to specific domains.

## Timeouts

### Request Timeouts

| Operation | Timeout |
|-----------|---------|
| Read timeout | 30 seconds |
| Write timeout | 30 seconds |
| Idle timeout | 60 seconds |

### Task Execution Timeouts

Task timeouts are configured at the platform level:

```bash
WORKFLOW_TIMEOUT_SECONDS=600  # 10 minutes default
```

Long-running tasks may timeout. Use streaming to monitor progress.

## Best Practices

### 1. Use Idempotency Keys

Always include `Idempotency-Key` for task submissions:

```python
import uuid
import httpx

idempotency_key = str(uuid.uuid4())

response = httpx.post(
    "http://localhost:8080/api/v1/tasks",
    headers={
        "X-API-Key": "sk_test_123456",
        "Idempotency-Key": idempotency_key
    },
    json={"query": "Analyze data"}
)
```

### 2. Handle Rate Limits

Implement exponential backoff:

```python
import time
import httpx

def submit_with_retry(query, max_retries=3):
    for attempt in range(max_retries):
        response = httpx.post(
            "http://localhost:8080/api/v1/tasks",
            headers={"X-API-Key": "sk_test_123456"},
            json={"query": query}
        )

        if response.status_code == 429:
            retry_after = int(response.headers.get("Retry-After", 60))
            time.sleep(retry_after)
            continue

        return response

    raise Exception("Max retries exceeded")
```

### 3. Use Streaming for Long Tasks

Don't poll status - use SSE streaming:

```python
import httpx

with httpx.stream(
    "GET",
    f"http://localhost:8080/api/v1/tasks/{task_id}/stream",
    headers={"X-API-Key": "sk_test_123456"}
) as response:
    for line in response.iter_lines():
        if line.startswith("data:"):
            event = json.loads(line[5:])
            print(event["type"], event["message"])
```

### 4. Enable Tracing

Pass trace context for observability:

```python
import uuid

trace_id = uuid.uuid4().hex + uuid.uuid4().hex  # 32 chars
parent_id = uuid.uuid4().hex[:16]               # 16 chars
traceparent = f"00-{trace_id}-{parent_id}-01"

response = httpx.post(
    "http://localhost:8080/api/v1/tasks",
    headers={
        "X-API-Key": "sk_test_123456",
        "traceparent": traceparent
    },
    json={"query": "Analyze data"}
)
```

### 5. Check Response Headers

Extract workflow and session IDs for tracking:

```python
response = httpx.post(
    "http://localhost:8080/api/v1/tasks",
    headers={"X-API-Key": "sk_test_123456"},
    json={"query": "Analyze data"}
)

workflow_id = response.headers.get("X-Workflow-ID")
session_id = response.headers.get("X-Session-ID")

print(f"Track at: http://localhost:8088/workflows/{workflow_id}")
```

## Quick Start Example

### Submit and Monitor Task

```bash
#!/bin/bash

API_KEY="sk_test_123456"
BASE_URL="http://localhost:8080"

# 1. Submit task
RESPONSE=$(curl -s -X POST "$BASE_URL/api/v1/tasks" \
  -H "X-API-Key: $API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"query": "What is the capital of France?"}')

TASK_ID=$(echo $RESPONSE | jq -r '.task_id')
echo "Task ID: $TASK_ID"

# 2. Check status
curl -s "$BASE_URL/api/v1/tasks/$TASK_ID" \
  -H "X-API-Key: $API_KEY" | jq

# 3. Get events
curl -s "$BASE_URL/api/v1/tasks/$TASK_ID/events" \
  -H "X-API-Key: $API_KEY" | jq

# 4. Stream events (SSE)
curl -N "$BASE_URL/api/v1/tasks/$TASK_ID/stream" \
  -H "X-API-Key: $API_KEY"
```

## Next Steps

<CardGroup cols={2}>
  <Card title="Submit Task" icon="paper-plane" href="/cn/api/rest/submit-task">
    POST /api/v1/tasks reference
  </Card>
  <Card title="List Tasks" icon="list" href="/cn/api/rest/list-tasks">
    GET /api/v1/tasks reference
  </Card>
  <Card title="Get Status" icon="circle-info" href="/cn/api/rest/get-status">
    GET /api/v1/tasks/{id} reference
  </Card>
  <Card title="Streaming" icon="stream" href="/cn/api/rest/streaming">
    Real-time event streaming
  </Card>
</CardGroup>


---

## 参与翻译

如果您想帮助翻译此文档，请访问我们的 [GitHub 仓库](https://github.com/Kocoro-lab/Shannon)。
