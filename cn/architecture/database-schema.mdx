---
title: "æ•°æ®åº“æ¶æ„"
description: "Complete PostgreSQL database schema reference for Shannon"
---

> ğŸš§ **ç¿»è¯‘è¿›è¡Œä¸­** - æ­¤æ–‡æ¡£æ­£åœ¨ä»è‹±æ–‡ç¿»è¯‘ä¸ºä¸­æ–‡

**åŸæ–‡ä»¶**: `architecture/database-schema.mdx`
**è‹±æ–‡ç‰ˆæœ¬**: [æŸ¥çœ‹è‹±æ–‡æ–‡æ¡£](/en/architecture/database-schema)

---


## æ¦‚è¿°

Shannon ä½¿ç”¨å¸¦ pgvector æ‰©å±•çš„ PostgreSQL è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ã€‚æ•°æ®åº“ç»„ç»‡ä¸ºä¸¤ä¸ªæ¨¡å¼ï¼š
- **`public`**: æ ¸å¿ƒåº”ç”¨è¡¨ï¼ˆä»»åŠ¡ã€ä¼šè¯ã€ç”¨æˆ·ã€äº‹ä»¶ï¼‰
- **`auth`**: èº«ä»½éªŒè¯å’Œå¤šç§Ÿæˆ·è¡¨

**æ€»è¡¨æ•°**: 18 å¼ è¡¨
**æ‰©å±•**: uuid-ossp, pg_trgm, btree_gin, pgcrypto

## å®ä½“å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  auth.tenants   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   auth.users    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”‚  auth.api_keys   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   N:1  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   public.users  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”‚   sessions       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   1:N  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   task_executions        â”‚
â”‚  (workflow_id = PK)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1:N
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   agent_executions       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”‚  tool_executions â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   1:N  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 1:N
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     tool_calls           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   event_logs             â”‚        â”‚  token_usage     â”‚
â”‚  (workflow_id)           â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  usage_daily_aggregates  â”‚        â”‚  learning_cases   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ¨¡å¼: `auth`ï¼ˆèº«ä»½éªŒè¯å’Œå¤šç§Ÿæˆ·ï¼‰

### auth.tenants

**ç”¨é€”**: å¤šç§Ÿæˆ·ç»„ç»‡ç®¡ç†

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT gen_random_uuid() | ç§Ÿæˆ·æ ‡è¯†ç¬¦ |
| name | VARCHAR(255) | NOT NULL | ç»„ç»‡åç§° |
| slug | VARCHAR(100) | UNIQUE, NOT NULL | URL å®‰å…¨æ ‡è¯†ç¬¦ |
| plan | VARCHAR(50) | DEFAULT 'free' | è®¢é˜…è®¡åˆ’ï¼ˆfree, pro, enterpriseï¼‰ |
| token_limit | INTEGER | DEFAULT 10000 | æ¯æœˆ token é…é¢ |
| monthly_token_usage | INTEGER | DEFAULT 0 | å½“å‰æœˆä½¿ç”¨é‡ |
| rate_limit_per_hour | INTEGER | DEFAULT 1000 | API é€Ÿç‡é™åˆ¶ |
| is_active | BOOLEAN | DEFAULT true | ç§Ÿæˆ·çŠ¶æ€ |
| created_at | TIMESTAMP | DEFAULT NOW() | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMP | DEFAULT NOW() | æœ€åæ›´æ–°æ—¶é—´ |
| metadata | JSONB | DEFAULT '{}' | é™„åŠ ç§Ÿæˆ·æ•°æ® |

**ç´¢å¼•**:
- æ— ï¼ˆå°è¡¨ï¼Œä¸»é”®è¶³å¤Ÿï¼‰

**ç¤ºä¾‹**:
```sql
-- è·å–æ‰€æœ‰æ´»åŠ¨ç§Ÿæˆ·
SELECT id, name, plan, token_limit
FROM auth.tenants
WHERE is_active = true;

-- æ£€æŸ¥ token ä½¿ç”¨æƒ…å†µ
SELECT name, monthly_token_usage, token_limit,
       (monthly_token_usage::FLOAT / token_limit * 100) as usage_percentage
FROM auth.tenants
WHERE monthly_token_usage > token_limit * 0.8;
```

### auth.users

**ç”¨é€”**: ç”¨æˆ·èº«ä»½éªŒè¯å’Œé…ç½®æ–‡ä»¶ç®¡ç†

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT gen_random_uuid() | ç”¨æˆ·æ ‡è¯†ç¬¦ |
| email | VARCHAR(255) | UNIQUE, NOT NULL | ç”¨æˆ·é‚®ç®± |
| username | VARCHAR(100) | UNIQUE, NOT NULL | ç”¨æˆ·å |
| password_hash | VARCHAR(255) | NOT NULL | Bcrypt å¯†ç å“ˆå¸Œ |
| full_name | VARCHAR(255) | | å…¨å |
| tenant_id | UUID | FK â†’ auth.tenants, NOT NULL | ç»„ç»‡ |
| role | VARCHAR(50) | DEFAULT 'user' | è§’è‰²ï¼ˆuser, admin, ownerï¼‰ |
| is_active | BOOLEAN | DEFAULT true | è´¦æˆ·çŠ¶æ€ |
| is_verified | BOOLEAN | DEFAULT false | é‚®ç®±éªŒè¯ |
| email_verified_at | TIMESTAMP | | éªŒè¯æ—¶é—´æˆ³ |
| created_at | TIMESTAMP | DEFAULT NOW() | è´¦æˆ·åˆ›å»º |
| updated_at | TIMESTAMP | DEFAULT NOW() | æœ€åæ›´æ–° |
| last_login | TIMESTAMP | | æœ€åç™»å½•æ—¶é—´ |
| metadata | JSONB | DEFAULT '{}' | é™„åŠ ç”¨æˆ·æ•°æ® |

**ç´¢å¼•**:
- `idx_users_tenant_id` ON (tenant_id)
- `idx_users_email` ON (email)

**ç¤ºä¾‹**:
```sql
-- è·å–ç§Ÿæˆ·ä¸­çš„æ‰€æœ‰ç”¨æˆ·
SELECT u.email, u.username, u.role, u.last_login
FROM auth.users u
WHERE u.tenant_id = '...'
  AND u.is_active = true
ORDER BY u.last_login DESC NULLS LAST;

-- æŸ¥æ‰¾éæ´»åŠ¨ç”¨æˆ·
SELECT email, created_at, last_login
FROM auth.users
WHERE last_login < NOW() - INTERVAL '90 days'
   OR last_login IS NULL;
```

### auth.api_keys

**ç”¨é€”**: ç”¨äºç¨‹åºåŒ–è®¿é—®çš„ API å¯†é’¥ç®¡ç†

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT gen_random_uuid() | å¯†é’¥æ ‡è¯†ç¬¦ |
| key_hash | VARCHAR(255) | UNIQUE, NOT NULL | å¯†é’¥çš„ SHA256 å“ˆå¸Œ |
| key_prefix | VARCHAR(20) | NOT NULL | å‰ 8 ä¸ªå­—ç¬¦ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰ |
| user_id | UUID | FK â†’ auth.users | å¯†é’¥æ‰€æœ‰è€… |
| tenant_id | UUID | FK â†’ auth.tenants, NOT NULL | ç»„ç»‡ |
| name | VARCHAR(100) | NOT NULL | å¯†é’¥åç§°/æè¿° |
| description | TEXT | | è¯¦ç»†æè¿° |
| scopes | TEXT[] | DEFAULT [...] | æƒé™æ•°ç»„ |
| rate_limit_per_hour | INTEGER | DEFAULT 1000 | å¯†é’¥ç‰¹å®šé€Ÿç‡é™åˆ¶ |
| last_used | TIMESTAMP | | æœ€åä½¿ç”¨æ—¶é—´æˆ³ |
| expires_at | TIMESTAMP | | è¿‡æœŸæ—¶é—´ |
| is_active | BOOLEAN | DEFAULT true | å¯†é’¥çŠ¶æ€ |
| created_at | TIMESTAMP | DEFAULT NOW() | åˆ›å»ºæ—¶é—´ |
| metadata | JSONB | DEFAULT '{}' | é™„åŠ å¯†é’¥æ•°æ® |

**ç´¢å¼•**:
- `idx_api_keys_tenant_id` ON (tenant_id)
- `idx_api_keys_key_prefix` ON (key_prefix)

**é»˜è®¤ä½œç”¨åŸŸ**:
- `workflows:read` - è¯»å–ä»»åŠ¡/å·¥ä½œæµæ•°æ®
- `workflows:write` - åˆ›å»º/ä¿®æ”¹å·¥ä½œæµ
- `agents:execute` - æ‰§è¡Œæ™ºèƒ½ä½“ä»»åŠ¡

**ç¤ºä¾‹**:
```sql
-- åˆ—å‡ºæ´»åŠ¨ API å¯†é’¥
SELECT key_prefix, name, last_used, expires_at
FROM auth.api_keys
WHERE is_active = true
  AND (expires_at IS NULL OR expires_at > NOW())
ORDER BY last_used DESC NULLS LAST;

-- æŸ¥æ‰¾æœªä½¿ç”¨çš„å¯†é’¥
SELECT key_prefix, name, created_at, last_used
FROM auth.api_keys
WHERE last_used IS NULL
  AND created_at < NOW() - INTERVAL '30 days';

-- æ£€æŸ¥å³å°†è¿‡æœŸçš„å¯†é’¥
SELECT key_prefix, name, expires_at
FROM auth.api_keys
WHERE expires_at BETWEEN NOW() AND NOW() + INTERVAL '7 days'
  AND is_active = true;
```

### auth.refresh_tokens

**ç”¨é€”**: JWT åˆ·æ–°ä»¤ç‰Œå­˜å‚¨å’Œæ’¤é”€

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT gen_random_uuid() | ä»¤ç‰Œæ ‡è¯†ç¬¦ |
| token_hash | VARCHAR(255) | UNIQUE, NOT NULL | SHA256 å“ˆå¸Œ |
| user_id | UUID | FK â†’ auth.users | ä»¤ç‰Œæ‰€æœ‰è€… |
| tenant_id | UUID | FK â†’ auth.tenants, NOT NULL | ç»„ç»‡ |
| expires_at | TIMESTAMP | NOT NULL | è¿‡æœŸæ—¶é—´ |
| revoked | BOOLEAN | DEFAULT false | æ’¤é”€çŠ¶æ€ |
| revoked_at | TIMESTAMP | | æ’¤é”€æ—¶é—´ |
| ip_address | INET | | å®¢æˆ·ç«¯ IP |
| user_agent | TEXT | | å®¢æˆ·ç«¯ç”¨æˆ·ä»£ç† |
| created_at | TIMESTAMP | DEFAULT NOW() | åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**:
- `idx_refresh_tokens_user_id` ON (user_id)
- `idx_refresh_tokens_token_hash` ON (token_hash)

**ç¤ºä¾‹**:
```sql
-- æ’¤é”€ç”¨æˆ·çš„æ‰€æœ‰ä»¤ç‰Œ
UPDATE auth.refresh_tokens
SET revoked = true, revoked_at = NOW()
WHERE user_id = '...'
  AND revoked = false;

-- æ¸…ç†è¿‡æœŸä»¤ç‰Œ
DELETE FROM auth.refresh_tokens
WHERE expires_at < NOW() - INTERVAL '7 days';
```

### auth.audit_logs

**ç”¨é€”**: å®‰å…¨äº‹ä»¶å®¡è®¡è·Ÿè¸ª

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT gen_random_uuid() | æ—¥å¿—æ¡ç›® ID |
| event_type | VARCHAR(100) | NOT NULL | äº‹ä»¶ç±»å‹ |
| user_id | UUID | FK â†’ auth.users | ç”¨æˆ·ï¼ˆå¯ä¸ºç©ºï¼‰ |
| tenant_id | UUID | FK â†’ auth.tenants | ç§Ÿæˆ·ï¼ˆå¯ä¸ºç©ºï¼‰ |
| ip_address | INET | | å®¢æˆ·ç«¯ IP |
| user_agent | TEXT | | å®¢æˆ·ç«¯ç”¨æˆ·ä»£ç† |
| details | JSONB | DEFAULT '{}' | äº‹ä»¶è¯¦æƒ… |
| created_at | TIMESTAMP | DEFAULT NOW() | äº‹ä»¶æ—¶é—´ |

**ç´¢å¼•**:
- `idx_audit_logs_user_id` ON (user_id)
- `idx_audit_logs_tenant_id` ON (tenant_id)
- `idx_audit_logs_event_type` ON (event_type)
- `idx_audit_logs_created_at` ON (created_at)

**äº‹ä»¶ç±»å‹**:
- `login`, `logout`, `login_failed`
- `api_key_created`, `api_key_revoked`
- `permission_changed`, `role_changed`
- `password_changed`, `email_verified`

**ç¤ºä¾‹**:
```sql
-- æœ€è¿‘çš„å®‰å…¨äº‹ä»¶
SELECT event_type, user_id, ip_address, created_at
FROM auth.audit_logs
WHERE created_at > NOW() - INTERVAL '24 hours'
ORDER BY created_at DESC
LIMIT 100;

-- å¤±è´¥çš„ç™»å½•å°è¯•
SELECT user_id, ip_address, COUNT(*) as attempts
FROM auth.audit_logs
WHERE event_type = 'login_failed'
  AND created_at > NOW() - INTERVAL '1 hour'
GROUP BY user_id, ip_address
HAVING COUNT(*) > 5;
```

## æ¨¡å¼: `public`ï¼ˆæ ¸å¿ƒåº”ç”¨ï¼‰

### users

**ç”¨é€”**: åº”ç”¨ç”¨æˆ·é…ç½®æ–‡ä»¶ï¼ˆæ—§ç‰ˆï¼Œé“¾æ¥åˆ° auth.usersï¼‰

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | ç”¨æˆ·æ ‡è¯†ç¬¦ |
| external_id | VARCHAR(255) | UNIQUE, NOT NULL | å¤–éƒ¨ç³»ç»Ÿ ID |
| email | VARCHAR(255) | | é‚®ç®±åœ°å€ |
| tenant_id | UUID | | ç§Ÿæˆ·å¼•ç”¨ |
| metadata | JSONB | DEFAULT '{}' | ç”¨æˆ·å…ƒæ•°æ® |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | åˆ›å»ºæ—¶é—´ |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | æœ€åæ›´æ–° |

**ç´¢å¼•**:
- `idx_users_tenant_id` ON (tenant_id)
- `idx_users_external_id` ON (external_id)

**æ³¨æ„**: æ­¤è¡¨å­˜åœ¨æ˜¯ä¸ºäº†å‘åå…¼å®¹ã€‚æ–°ä»£ç åº”ä½¿ç”¨ `auth.users`ã€‚

### sessions

**ç”¨é€”**: ç”¨æˆ·ä¼šè¯ç®¡ç†å’Œä¸Šä¸‹æ–‡

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | ä¼šè¯æ ‡è¯†ç¬¦ |
| user_id | UUID | FK â†’ users | ä¼šè¯æ‰€æœ‰è€… |
| tenant_id | UUID | | ç§Ÿæˆ·å¼•ç”¨ |
| context | JSONB | DEFAULT '{}' | ä¼šè¯ä¸Šä¸‹æ–‡æ•°æ® |
| token_budget | INTEGER | DEFAULT 10000 | Token åˆ†é… |
| tokens_used | INTEGER | DEFAULT 0 | å·²æ¶ˆè´¹çš„ tokens |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | ä¼šè¯å¼€å§‹ |
| updated_at | TIMESTAMPTZ | DEFAULT NOW() | æœ€åæ´»åŠ¨ |
| expires_at | TIMESTAMPTZ | | è¿‡æœŸæ—¶é—´ |

**ç´¢å¼•**:
- `idx_sessions_user_id` ON (user_id)
- `idx_sessions_tenant_id` ON (tenant_id)
- `idx_sessions_expires_at` ON (expires_at)

**ç¤ºä¾‹**:
```sql
-- æ´»åŠ¨ä¼šè¯
SELECT id, user_id, tokens_used, token_budget, created_at
FROM sessions
WHERE expires_at > NOW()
  OR expires_at IS NULL
ORDER BY created_at DESC;

-- ä¼šè¯ token ä½¿ç”¨æƒ…å†µ
SELECT
    COUNT(*) as session_count,
    AVG(tokens_used) as avg_tokens,
    SUM(tokens_used) as total_tokens
FROM sessions
WHERE created_at > NOW() - INTERVAL '24 hours';
```

### task_executions

**ç”¨é€”**: ä»»åŠ¡/å·¥ä½œæµæ‰§è¡Œå†å²å’ŒæŒ‡æ ‡

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | ä»»åŠ¡æ ‡è¯†ç¬¦ |
| workflow_id | VARCHAR(255) | UNIQUE, NOT NULL | Temporal å·¥ä½œæµ ID |
| user_id | UUID | FK â†’ users | ä»»åŠ¡åˆ›å»ºè€… |
| tenant_id | UUID | | ç§Ÿæˆ·å¼•ç”¨ |
| session_id | VARCHAR(255) | | ä¼šè¯æ ‡è¯†ç¬¦ |
| query | TEXT | NOT NULL | ä»»åŠ¡æŸ¥è¯¢/æç¤º |
| mode | VARCHAR(50) | | æ‰§è¡Œæ¨¡å¼ï¼ˆSIMPLE, STANDARD, COMPLEXï¼‰ |
| status | VARCHAR(50) | NOT NULL | ä»»åŠ¡çŠ¶æ€ |
| started_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | å¼€å§‹æ—¶é—´ |
| completed_at | TIMESTAMPTZ | | å®Œæˆæ—¶é—´ |
| result | TEXT | | æœ€ç»ˆç»“æœ |
| response | JSONB | DEFAULT '{}' | ç»“æ„åŒ–å“åº” |
| error_message | TEXT | | é”™è¯¯è¯¦æƒ… |
| total_tokens | INTEGER | DEFAULT 0 | ä½¿ç”¨çš„æ€» tokens |
| prompt_tokens | INTEGER | DEFAULT 0 | è¾“å…¥ tokens |
| completion_tokens | INTEGER | DEFAULT 0 | è¾“å‡º tokens |
| total_cost_usd | DECIMAL(10,6) | DEFAULT 0 | æ€»æˆæœ¬ |
| duration_ms | INTEGER | | æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| agents_used | INTEGER | DEFAULT 0 | æ™ºèƒ½ä½“æ•°é‡ |
| tools_invoked | INTEGER | DEFAULT 0 | å·¥å…·è°ƒç”¨æ•°é‡ |
| cache_hits | INTEGER | DEFAULT 0 | ç¼“å­˜å‘½ä¸­æ•° |
| complexity_score | DECIMAL(3,2) | | å¤æ‚åº¦ï¼ˆ0.0-1.0ï¼‰ |
| metadata | JSONB | | é™„åŠ å…ƒæ•°æ® |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | è®°å½•åˆ›å»º |

**ç´¢å¼•**:
- `idx_task_user_session` ON (user_id, session_id)
- `idx_task_created_at` ON (created_at DESC)
- `idx_task_status` ON (status)
- `idx_task_workflow_id` ON (workflow_id)
- `idx_task_executions_tenant_id` ON (tenant_id)
- `idx_task_executions_response` GIN (response)

**çŠ¶æ€å€¼**:
- `RUNNING` - ä»»åŠ¡æ‰§è¡Œä¸­
- `COMPLETED` - æˆåŠŸå®Œæˆ
- `FAILED` - å¤±è´¥å¹¶æŠ¥é”™
- `CANCELLED` - ç”¨æˆ·å–æ¶ˆ

**ç¤ºä¾‹**:
```sql
-- ç”¨æˆ·æœ€è¿‘çš„ä»»åŠ¡
SELECT workflow_id, query, status, duration_ms, total_cost_usd
FROM task_executions
WHERE user_id = '...'
ORDER BY started_at DESC
LIMIT 20;

-- å¤±è´¥ä»»åŠ¡åˆ†æ
SELECT
    DATE(started_at) as date,
    COUNT(*) as failed_count,
    AVG(duration_ms) as avg_duration
FROM task_executions
WHERE status = 'FAILED'
  AND started_at > NOW() - INTERVAL '7 days'
GROUP BY DATE(started_at)
ORDER BY date DESC;

-- æˆæœ¬åˆ†æ
SELECT
    user_id,
    COUNT(*) as task_count,
    SUM(total_cost_usd) as total_cost,
    AVG(total_cost_usd) as avg_cost,
    SUM(total_tokens) as total_tokens
FROM task_executions
WHERE started_at > NOW() - INTERVAL '30 days'
GROUP BY user_id
ORDER BY total_cost DESC;
```

### agent_executions

**ç”¨é€”**: ä»»åŠ¡ä¸­å•ä¸ªæ™ºèƒ½ä½“æ‰§è¡Œçš„è¯¦ç»†ä¿¡æ¯

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | æ‰§è¡Œ ID |
| task_execution_id | UUID | FK â†’ task_executions | çˆ¶ä»»åŠ¡ |
| agent_id | VARCHAR(255) | NOT NULL | æ™ºèƒ½ä½“æ ‡è¯†ç¬¦ |
| execution_order | INTEGER | NOT NULL | æ‰§è¡Œé¡ºåº |
| input | TEXT | NOT NULL | æ™ºèƒ½ä½“è¾“å…¥ |
| output | TEXT | | æ™ºèƒ½ä½“è¾“å‡º |
| mode | VARCHAR(50) | | æ‰§è¡Œæ¨¡å¼ |
| state | VARCHAR(50) | | FSM çŠ¶æ€ |
| tokens_used | INTEGER | DEFAULT 0 | æ¶ˆè´¹çš„ tokens |
| cost_usd | DECIMAL(10,6) | DEFAULT 0 | æ‰§è¡Œæˆæœ¬ |
| model_used | VARCHAR(100) | | LLM æ¨¡å‹ |
| duration_ms | INTEGER | | æ‰§è¡Œæ—¶é—´ |
| memory_used_mb | INTEGER | | å†…å­˜ä½¿ç”¨ |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | å¼€å§‹æ—¶é—´ |
| completed_at | TIMESTAMPTZ | | å®Œæˆæ—¶é—´ |

**ç´¢å¼•**:
- `idx_agent_task_execution` ON (task_execution_id)
- `idx_agent_created_at` ON (created_at DESC)
- `idx_agent_state` ON (state)

**çŠ¶æ€å€¼**:
- `IDLE` - å‡†å¤‡æ‰§è¡Œ
- `ANALYZING` - åˆ†æè¾“å…¥
- `PLANNING` - åˆ›å»ºæ‰§è¡Œè®¡åˆ’
- `RETRIEVING` - æ£€ç´¢ä¸Šä¸‹æ–‡
- `EXECUTING` - è¿è¡Œå·¥å…·
- `VALIDATING` - éªŒè¯è¾“å‡º
- `SYNTHESIZING` - ç»¼åˆç»“æœ
- `COMPLETED` - æˆåŠŸå®Œæˆ
- `FAILED` - å¤±è´¥å¹¶æŠ¥é”™

**ç¤ºä¾‹**:
```sql
-- ä»»åŠ¡çš„æ™ºèƒ½ä½“æ‰§è¡Œé“¾
SELECT agent_id, execution_order, state, duration_ms, tokens_used
FROM agent_executions
WHERE task_execution_id = '...'
ORDER BY execution_order;

-- æ™ºèƒ½ä½“æ€§èƒ½æŒ‡æ ‡
SELECT
    agent_id,
    COUNT(*) as execution_count,
    AVG(duration_ms) as avg_duration,
    AVG(tokens_used) as avg_tokens,
    SUM(cost_usd) as total_cost
FROM agent_executions
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY agent_id
ORDER BY execution_count DESC;
```

### tool_executions

**ç”¨é€”**: å·¥å…·è°ƒç”¨å†å²å’Œæ€§èƒ½

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | æ‰§è¡Œ ID |
| agent_execution_id | UUID | FK â†’ agent_executions | çˆ¶æ™ºèƒ½ä½“ |
| task_execution_id | UUID | FK â†’ task_executions | çˆ¶ä»»åŠ¡ |
| tool_name | VARCHAR(255) | NOT NULL | å·¥å…·æ ‡è¯†ç¬¦ |
| tool_version | VARCHAR(50) | | å·¥å…·ç‰ˆæœ¬ |
| category | VARCHAR(100) | | å·¥å…·ç±»åˆ« |
| input_params | JSONB | | è¾“å…¥å‚æ•° |
| output | JSONB | | å·¥å…·è¾“å‡º |
| success | BOOLEAN | DEFAULT true | æˆåŠŸçŠ¶æ€ |
| error_message | TEXT | | é”™è¯¯è¯¦æƒ… |
| duration_ms | INTEGER | | æ‰§è¡Œæ—¶é—´ |
| tokens_consumed | INTEGER | DEFAULT 0 | ä½¿ç”¨çš„ tokens |
| sandboxed | BOOLEAN | DEFAULT true | ä½¿ç”¨ WASI æ²™ç®± |
| memory_used_mb | INTEGER | | å†…å­˜ä½¿ç”¨ |
| executed_at | TIMESTAMPTZ | DEFAULT NOW() | æ‰§è¡Œæ—¶é—´ |

**ç´¢å¼•**:
- `idx_tool_name` ON (tool_name)
- `idx_tool_executed_at` ON (executed_at DESC)
- `idx_tool_task_execution` ON (task_execution_id)
- `idx_tool_success` ON (success)

**å·¥å…·ç±»åˆ«**:
- `search` - ç½‘ç»œæœç´¢å·¥å…·
- `calculation` - æ•°å­¦/è®¡ç®—
- `file` - æ–‡ä»¶æ“ä½œ
- `database` - æ•°æ®åº“æŸ¥è¯¢
- `api` - å¤–éƒ¨ API è°ƒç”¨

**ç¤ºä¾‹**:
```sql
-- å·¥å…·ä½¿ç”¨ç»Ÿè®¡
SELECT
    tool_name,
    COUNT(*) as invocation_count,
    COUNT(CASE WHEN success THEN 1 END) as successful,
    AVG(duration_ms) as avg_duration
FROM tool_executions
WHERE executed_at > NOW() - INTERVAL '7 days'
GROUP BY tool_name
ORDER BY invocation_count DESC;

-- å¤±è´¥çš„å·¥å…·æ‰§è¡Œ
SELECT tool_name, error_message, executed_at
FROM tool_executions
WHERE success = false
  AND executed_at > NOW() - INTERVAL '24 hours'
ORDER BY executed_at DESC;

-- å·¥å…·æ€§èƒ½
SELECT
    tool_name,
    AVG(duration_ms) as avg_ms,
    MAX(duration_ms) as max_ms,
    STDDEV(duration_ms) as stddev_ms
FROM tool_executions
WHERE success = true
GROUP BY tool_name
ORDER BY avg_ms DESC;
```

### event_logs

**ç”¨é€”**: ç”¨äºå®¡è®¡å’Œé‡æ’­çš„æµå¼äº‹ä»¶å­˜å‚¨

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | äº‹ä»¶ ID |
| workflow_id | VARCHAR(255) | NOT NULL | å·¥ä½œæµæ ‡è¯†ç¬¦ |
| task_id | UUID | | ä»»åŠ¡å¼•ç”¨ï¼ˆå¯ä¸ºç©ºï¼‰ |
| type | VARCHAR(100) | NOT NULL | äº‹ä»¶ç±»å‹ |
| agent_id | VARCHAR(255) | | æ™ºèƒ½ä½“æ ‡è¯†ç¬¦ |
| message | TEXT | | äº‹ä»¶æ¶ˆæ¯ |
| payload | JSONB | DEFAULT '{}' | äº‹ä»¶è´Ÿè½½ |
| timestamp | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | äº‹ä»¶æ—¶é—´ |
| seq | BIGINT | | åºåˆ—å· |
| stream_id | VARCHAR(64) | | Redis æµ ID |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT NOW() | è®°å½•åˆ›å»º |

**ç´¢å¼•**:
- `idx_event_logs_workflow_id` ON (workflow_id)
- `idx_event_logs_task_id` ON (task_id)
- `idx_event_logs_type` ON (type)
- `idx_event_logs_ts` ON (timestamp DESC)
- `idx_event_logs_seq` ON (workflow_id, seq)
- `idx_event_logs_workflow_ts` ON (workflow_id, timestamp DESC)
- `uq_event_logs_wf_type_seq` UNIQUE (workflow_id, type, seq) WHERE seq IS NOT NULL

**äº‹ä»¶ç±»å‹**:
- `TASK_STARTED`, `TASK_COMPLETED`, `TASK_FAILED`
- `AGENT_ASSIGNED`, `AGENT_THINKING`, `AGENT_COMPLETED`
- `TOOL_INVOKED`, `TOOL_RESULT`, `TOOL_ERROR`
- `WORKFLOW_STARTED`, `WORKFLOW_COMPLETED`

**ç¤ºä¾‹**:
```sql
-- è·å–ä»»åŠ¡çš„æ‰€æœ‰äº‹ä»¶
SELECT type, agent_id, message, timestamp
FROM event_logs
WHERE workflow_id = '...'
ORDER BY timestamp;

-- äº‹ä»¶é¢‘ç‡åˆ†æ
SELECT
    type,
    COUNT(*) as event_count,
    DATE_TRUNC('hour', timestamp) as hour
FROM event_logs
WHERE timestamp > NOW() - INTERVAL '24 hours'
GROUP BY type, hour
ORDER BY hour DESC, event_count DESC;
```

### token_usage

**ç”¨é€”**: æ¯ä»»åŠ¡çš„è¯¦ç»† token ä½¿ç”¨è·Ÿè¸ª

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | è®°å½• ID |
| user_id | UUID | FK â†’ users | ç”¨æˆ· |
| task_id | UUID | FK â†’ task_executions | ä»»åŠ¡ |
| provider | VARCHAR(50) | NOT NULL | LLM æä¾›å•† |
| model | VARCHAR(255) | NOT NULL | æ¨¡å‹åç§° |
| prompt_tokens | INTEGER | NOT NULL | è¾“å…¥ tokens |
| completion_tokens | INTEGER | NOT NULL | è¾“å‡º tokens |
| total_tokens | INTEGER | NOT NULL | æ€» tokens |
| cost_usd | DECIMAL(10,6) | NOT NULL | æˆæœ¬ï¼ˆç¾å…ƒï¼‰ |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | è®°å½•æ—¶é—´ |

**ç´¢å¼•**:
- `idx_token_usage_user_id` ON (user_id)
- `idx_token_usage_task_id` ON (task_id)
- `idx_token_usage_created_at` ON (created_at DESC)
- `idx_token_usage_provider_model` ON (provider, model)

**ç¤ºä¾‹**:
```sql
-- æŒ‰æä¾›å•†ç»Ÿè®¡ token ä½¿ç”¨
SELECT
    provider,
    model,
    COUNT(*) as call_count,
    SUM(total_tokens) as total_tokens,
    SUM(cost_usd) as total_cost
FROM token_usage
WHERE created_at > NOW() - INTERVAL '30 days'
GROUP BY provider, model
ORDER BY total_cost DESC;

-- æ¯æ—¥ token è¶‹åŠ¿
SELECT
    DATE(created_at) as date,
    SUM(total_tokens) as tokens,
    SUM(cost_usd) as cost
FROM token_usage
WHERE created_at > NOW() - INTERVAL '30 days'
GROUP BY DATE(created_at)
ORDER BY date;
```

### usage_daily_aggregates

**ç”¨é€”**: é¢„è®¡ç®—çš„æ¯æ—¥ä½¿ç”¨ç»Ÿè®¡

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | UUID | PK, DEFAULT uuid_generate_v4() | è®°å½• ID |
| user_id | UUID | FK â†’ users | ç”¨æˆ· |
| date | DATE | NOT NULL | èšåˆæ—¥æœŸ |
| total_tasks | INTEGER | DEFAULT 0 | æ€»ä»»åŠ¡æ•° |
| successful_tasks | INTEGER | DEFAULT 0 | æˆåŠŸæ•° |
| failed_tasks | INTEGER | DEFAULT 0 | å¤±è´¥æ•° |
| total_tokens | INTEGER | DEFAULT 0 | æ€» tokens |
| total_cost_usd | DECIMAL(10,6) | DEFAULT 0 | æ€»æˆæœ¬ |
| model_usage | JSONB | | æ¨¡å‹åˆ†å¸ƒ |
| tools_invoked | INTEGER | DEFAULT 0 | å·¥å…·è°ƒç”¨æ¬¡æ•° |
| tool_distribution | JSONB | | å·¥å…·ä½¿ç”¨åˆ†å¸ƒ |
| avg_duration_ms | INTEGER | | å¹³å‡ä»»åŠ¡æŒç»­æ—¶é—´ |
| cache_hit_rate | DECIMAL(3,2) | | ç¼“å­˜å‘½ä¸­ç‡ |
| created_at | TIMESTAMPTZ | DEFAULT NOW() | è®°å½•æ—¶é—´ |

**ç´¢å¼•**:
- `idx_usage_daily_user_date` ON (user_id, date)
- `idx_usage_daily_date` ON (date DESC)

**å”¯ä¸€çº¦æŸ**: (user_id, date)

**ç¤ºä¾‹**:
```sql
-- ç”¨æˆ·ä½¿ç”¨æ‘˜è¦
SELECT date, total_tasks, successful_tasks, total_cost_usd
FROM usage_daily_aggregates
WHERE user_id = '...'
  AND date > CURRENT_DATE - INTERVAL '30 days'
ORDER BY date DESC;

-- èšåˆæŒ‡æ ‡
SELECT
    SUM(total_tasks) as total_tasks,
    SUM(total_cost_usd) as total_cost,
    AVG(cache_hit_rate) as avg_cache_rate
FROM usage_daily_aggregates
WHERE date > CURRENT_DATE - INTERVAL '7 days';
```

## å…¶ä»–è¡¨

### tool_calls

**ç”¨é€”**: æ—§ç‰ˆå·¥å…·è°ƒç”¨è·Ÿè¸ªï¼ˆè¯·ä½¿ç”¨ tool_executionsï¼‰

### prompts

**ç”¨é€”**: æç¤ºç‰ˆæœ¬æ§åˆ¶å’Œ A/B æµ‹è¯•

### learning_cases

**ç”¨é€”**: å¼ºåŒ–å­¦ä¹ æ¡ˆä¾‹å­˜å‚¨

### session_archives

**ç”¨é€”**: æ¥è‡ª Redis çš„é•¿æœŸä¼šè¯å¿«ç…§

### audit_logs (public)

**ç”¨é€”**: åº”ç”¨å®¡è®¡è·Ÿè¸ªï¼ˆä¸ auth.audit_logs åˆ†å¼€ï¼‰

## æ•°æ®åº“å‡½æ•°

### update_updated_at_column()

**ç”¨é€”**: åœ¨è¡Œæ›´æ”¹æ—¶è‡ªåŠ¨æ›´æ–° `updated_at`

**ç”¨æ³•**: ä½œä¸ºè§¦å‘å™¨é™„åŠ åˆ° `users` å’Œ `sessions` è¡¨

```sql
CREATE TRIGGER update_users_updated_at
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

### update_daily_aggregate(user_id, date)

**ç”¨é€”**: æ›´æ–°æˆ–åˆ›å»ºç”¨æˆ·çš„æ¯æ—¥ä½¿ç”¨èšåˆ

**ç”¨æ³•**: åœ¨ä»»åŠ¡å®Œæˆæ—¶é€šè¿‡è§¦å‘å™¨è‡ªåŠ¨è°ƒç”¨

```sql
-- æ‰‹åŠ¨è°ƒç”¨
SELECT update_daily_aggregate(
    '00000000-0000-0000-0000-000000000002',
    '2025-10-22'
);
```

### trigger_update_daily_aggregate()

**ç”¨é€”**: åœ¨ä»»åŠ¡çŠ¶æ€æ›´æ”¹æ—¶æ›´æ–°èšåˆçš„è§¦å‘å™¨å‡½æ•°

**ç”¨æ³•**: åœ¨ task_executions INSERT/UPDATE æ—¶è‡ªåŠ¨è§¦å‘

## ç¤ºä¾‹æŸ¥è¯¢

### ä»»åŠ¡åˆ†æ

```sql
-- æŒ‰æ¨¡å¼ç»Ÿè®¡ä»»åŠ¡æˆåŠŸç‡
SELECT
    mode,
    COUNT(*) as total,
    COUNT(CASE WHEN status = 'COMPLETED' THEN 1 END) as completed,
    ROUND(100.0 * COUNT(CASE WHEN status = 'COMPLETED' THEN 1 END) / COUNT(*), 2) as success_rate
FROM task_executions
WHERE started_at > NOW() - INTERVAL '7 days'
GROUP BY mode;

-- æŒ‰å¤æ‚åº¦ç»Ÿè®¡å¹³å‡æ‰§è¡Œæ—¶é—´
SELECT
    CASE
        WHEN complexity_score < 0.3 THEN 'Low'
        WHEN complexity_score < 0.7 THEN 'Medium'
        ELSE 'High'
    END as complexity,
    COUNT(*) as task_count,
    AVG(duration_ms) as avg_ms,
    AVG(total_cost_usd) as avg_cost
FROM task_executions
WHERE complexity_score IS NOT NULL
GROUP BY complexity;
```

### æˆæœ¬åˆ†æ

```sql
-- æˆæœ¬æœ€é«˜çš„ç”¨æˆ·
SELECT
    u.email,
    COUNT(t.id) as task_count,
    SUM(t.total_cost_usd) as total_cost,
    AVG(t.total_cost_usd) as avg_cost
FROM task_executions t
JOIN users u ON t.user_id = u.id
WHERE t.started_at > NOW() - INTERVAL '30 days'
GROUP BY u.email
ORDER BY total_cost DESC
LIMIT 10;

-- æŒ‰æ¨¡å‹ç»Ÿè®¡æˆæœ¬æ˜ç»†
SELECT
    tu.provider,
    tu.model,
    COUNT(*) as usage_count,
    SUM(tu.total_tokens) as total_tokens,
    SUM(tu.cost_usd) as total_cost,
    AVG(tu.cost_usd) as avg_cost_per_call
FROM token_usage tu
WHERE tu.created_at > NOW() - INTERVAL '7 days'
GROUP BY tu.provider, tu.model
ORDER BY total_cost DESC;
```

### æ€§èƒ½ç›‘æ§

```sql
-- æ…¢æŸ¥è¯¢ï¼ˆä»»åŠ¡è¶…è¿‡ 60 ç§’ï¼‰
SELECT
    workflow_id,
    query,
    duration_ms,
    agents_used,
    tools_invoked
FROM task_executions
WHERE duration_ms > 60000
  AND started_at > NOW() - INTERVAL '24 hours'
ORDER BY duration_ms DESC;

-- å·¥å…·æ‰§è¡ŒæˆåŠŸç‡
SELECT
    tool_name,
    COUNT(*) as total,
    COUNT(CASE WHEN success THEN 1 END) as successful,
    ROUND(100.0 * COUNT(CASE WHEN success THEN 1 END) / COUNT(*), 2) as success_rate,
    AVG(duration_ms) as avg_duration
FROM tool_executions
GROUP BY tool_name
ORDER BY total DESC;
```

## æœ€ä½³å®è·µ

### 1. ç´¢å¼•

**å§‹ç»ˆä¸ºä»¥ä¸‹é¡¹ä½¿ç”¨ç´¢å¼•**:
- å¤–é”®åˆ—
- æ—¶é—´æˆ³åˆ—ï¼ˆç”¨äºæ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼‰
- çŠ¶æ€/æšä¸¾åˆ—ï¼ˆç”¨äºè¿‡æ»¤ï¼‰
- é¢‘ç¹æœç´¢çš„åˆ—

**å½“å‰ç´¢å¼•è¦†ç›–**: ä¼˜ç§€ï¼ˆæ‰€æœ‰å¤–é”®å’Œå¸¸è§æŸ¥è¯¢éƒ½å·²ç´¢å¼•ï¼‰

### 2. åˆ†åŒº

å¯¹äºé«˜å®¹é‡è¡¨ï¼Œè€ƒè™‘åˆ†åŒºï¼š

```sql
-- ä¸º task_executions è¿›è¡ŒæŒ‰æœˆåˆ†åŒº
CREATE TABLE task_executions_2025_10 PARTITION OF task_executions
    FOR VALUES FROM ('2025-10-01') TO ('2025-11-01');
```

### 3. æ•°æ®ä¿ç•™

**æ¨èç­–ç•¥**:
- `event_logs`: 90 å¤©ï¼ˆé«˜å®¹é‡ï¼‰
- `task_executions`: 1 å¹´
- `audit_logs`: 7 å¹´ï¼ˆåˆè§„ï¼‰
- `session_archives`: 90 å¤©

**æ¸…ç†è„šæœ¬**:
```sql
-- åˆ é™¤æ—§äº‹ä»¶ï¼ˆæ¯æœˆè¿è¡Œï¼‰
DELETE FROM event_logs
WHERE created_at < NOW() - INTERVAL '90 days';

-- å½’æ¡£æ—§ä»»åŠ¡ï¼ˆæ¯å¹´è¿è¡Œï¼‰
INSERT INTO task_executions_archive
SELECT * FROM task_executions
WHERE started_at < NOW() - INTERVAL '1 year';

DELETE FROM task_executions
WHERE started_at < NOW() - INTERVAL '1 year';
```

### 4. æŸ¥è¯¢ä¼˜åŒ–

**ä½¿ç”¨ EXPLAIN ANALYZE**:
```sql
EXPLAIN ANALYZE
SELECT * FROM task_executions
WHERE user_id = '...'
  AND started_at > NOW() - INTERVAL '7 days';
```

**ä½¿ç”¨è¦†ç›–ç´¢å¼•ä¼˜åŒ–**:
```sql
CREATE INDEX idx_task_user_date_status
ON task_executions(user_id, started_at, status)
INCLUDE (total_cost_usd, duration_ms);
```

### 5. è¿æ¥æ± 

**é…ç½®**ï¼ˆå·²åœ¨ Shannon ä¸­é…ç½®ï¼‰:
```bash
DB_MAX_OPEN_CONNS=50
DB_MAX_IDLE_CONNS=10
```

## ç»´æŠ¤

### æ¸…ç†å’Œåˆ†æ

```sql
-- æ‰‹åŠ¨æ¸…ç†ï¼ˆæ¯å‘¨è¿è¡Œï¼‰
VACUUM ANALYZE task_executions;
VACUUM ANALYZE event_logs;

-- é…ç½®è‡ªåŠ¨æ¸…ç†
ALTER TABLE task_executions SET (autovacuum_vacuum_threshold = 1000);
```

### ç»Ÿè®¡

```sql
-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE task_executions;

-- æ£€æŸ¥è¡¨è†¨èƒ€
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

## ç›¸å…³æ–‡æ¡£

<CardGroup cols={2}>
  <Card title="æ•°æ®æµ" icon="diagram-project" href="/cn/architecture/data-flow">
    æ•°æ®æµæ¶æ„
  </Card>
  <Card title="ç¯å¢ƒå˜é‡" icon="gear" href="/cn/deployment/environment-variables">
    æ•°æ®åº“é…ç½®
  </Card>
  <Card title="æ€§èƒ½è°ƒä¼˜" icon="gauge" href="/cn/deployment/performance-tuning">
    æŸ¥è¯¢ä¼˜åŒ–
  </Card>
  <Card title="ç›‘æ§" icon="chart-line" href="/cn/deployment/monitoring">
    æ•°æ®åº“ç›‘æ§
  </Card>
</CardGroup>


---

## å‚ä¸ç¿»è¯‘

å¦‚æœæ‚¨æƒ³å¸®åŠ©ç¿»è¯‘æ­¤æ–‡æ¡£ï¼Œè¯·è®¿é—®æˆ‘ä»¬çš„ [GitHub ä»“åº“](https://github.com/Kocoro-lab/Shannon)ã€‚
