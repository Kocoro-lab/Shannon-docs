---
title: "é”™è¯¯å¤„ç†"
description: "åœ¨ Shannon Python SDK ä¸­ä¼˜é›…åœ°å¤„ç†é”™è¯¯"
---

<Note>
æ­£åœ¨æ‰©å±•é”™è¯¯å¤„ç†æ–‡æ¡£ã€‚ä¸‹é¢æ˜¾ç¤ºäº†æ ¸å¿ƒæ¨¡å¼ã€‚
</Note>

## æ¦‚è¿°

Shannon Python SDK æä¾›å…¨é¢çš„é”™è¯¯å¤„ç†ä»¥å¸®åŠ©æ‚¨æ„å»ºå¼ºå¤§çš„åº”ç”¨ç¨‹åºã€‚æ‰€æœ‰ SDK å¼‚å¸¸éƒ½ç»§æ‰¿è‡ª `ShannonError`ã€‚

## å¼‚å¸¸å±‚æ¬¡ç»“æ„

```python
ShannonError                    # åŸºç¡€å¼‚å¸¸
â”œâ”€â”€ ConnectionError             # ç½‘ç»œ/è¿æ¥é—®é¢˜ï¼ˆSDK è‡ªå®šä¹‰å¼‚å¸¸ï¼‰
â”œâ”€â”€ AuthenticationError         # API å¯†é’¥/èº«ä»½éªŒè¯é—®é¢˜
â”œâ”€â”€ PermissionDeniedError       # æƒé™ä¸è¶³/ç¦æ­¢è®¿é—®
â”œâ”€â”€ ValidationError             # æ— æ•ˆå‚æ•°
â”œâ”€â”€ RateLimitError              # é€Ÿç‡é™åˆ¶/è¯·æ±‚è¿‡å¤š
â”œâ”€â”€ ServerError                 # ä¸Šæ¸¸ 5xx æœåŠ¡å™¨é”™è¯¯
â”œâ”€â”€ TaskNotFoundError           # ä»»åŠ¡ä¸å­˜åœ¨
â”œâ”€â”€ TaskTimeoutError            # ä»»åŠ¡è¶…å‡ºè¶…æ—¶
â”œâ”€â”€ TaskCancelledError          # ä»»åŠ¡è¢«å–æ¶ˆ
â”œâ”€â”€ SessionNotFoundError        # ä¼šè¯ä¸å­˜åœ¨
â”œâ”€â”€ SessionExpiredError         # ä¼šè¯å·²è¿‡æœŸ
â”œâ”€â”€ TemplateError               # æ¨¡æ¿/è·¯ç”±ç›¸å…³é”™è¯¯
â””â”€â”€ TemplateNotFoundError       # æ¨¡æ¿ä¸å­˜åœ¨
```

<Note>
é¢„ç®—å’Œä»»åŠ¡å¤±è´¥å¤„ç†ï¼šé¢„ç®—è¶…å‡ºå’Œä»»åŠ¡å¤±è´¥ä¸æ˜¯å¼‚å¸¸ã€‚å¤±è´¥è¯·æ£€æŸ¥ `status.status`ã€‚ä»¤ç‰Œç”¨é‡ä¸æˆæœ¬åˆè®¡è¯·é€šè¿‡ `list_tasks()` è¯»å–ä»»åŠ¡åˆ—è¡¨ä¸­çš„ `total_token_usage`ã€‚
</Note>

## åŸºæœ¬é”™è¯¯å¤„ç†

### Try-Catch æ¨¡å¼

```python
from shannon import (
    ShannonClient,
    ShannonError,
    AuthenticationError,
    PermissionDeniedError,
    ConnectionError,
    RateLimitError,
    ServerError,
    TaskTimeoutError,
    TaskStatusEnum,
)

client = ShannonClient(base_url="http://localhost:8080")

try:
    handle = client.submit_task(query="åˆ†ææ­¤æ•°æ®")
    status = client.wait(handle.task_id, timeout=120)

    if status.status == TaskStatusEnum.FAILED:
        print(f"ä»»åŠ¡å¤±è´¥ï¼š{status.error_message}")
    else:
        print("ç»“æœï¼š", status.result)

except ConnectionError:
    print("æ— æ³•è¿æ¥åˆ° Shannon æœåŠ¡å™¨")
except AuthenticationError:
    print("æ— æ•ˆçš„ API å‡­è¯")
except PermissionDeniedError:
    print("ç¦æ­¢è®¿é—®ï¼šæƒé™ä¸è¶³")
except RateLimitError:
    print("è§¦å‘é€Ÿç‡é™åˆ¶ï¼Œè¯·é™ä½é¢‘ç‡æˆ–åŠ å…¥é€€é¿")
except ServerError:
    print("æœåŠ¡å™¨é”™è¯¯ï¼ˆ5xxï¼‰ï¼Œç¨åå†è¯•")
except TaskTimeoutError:
    print("ä»»åŠ¡è¶…å‡ºè¶…æ—¶é™åˆ¶")
except ShannonError as e:
    print(f"Shannon é”™è¯¯ï¼š{e}")
except Exception as e:
    print(f"æ„å¤–é”™è¯¯ï¼š{e}")
```

## ç‰¹å®šé”™è¯¯ç±»å‹

### è¿æ¥é”™è¯¯

å¤„ç†ç½‘ç»œå’Œè¿æ¥é—®é¢˜ï¼š

```python
import time
from shannon import ShannonClient, ConnectionError

def connect_with_retry(max_retries=3):
    client = ShannonClient()

    for attempt in range(max_retries):
        try:
            # ä½¿ç”¨ç®€å•ä»»åŠ¡æµ‹è¯•è¿æ¥
            handle = client.submit_task(query="ping")
            return client

        except ConnectionError as e:
            if attempt < max_retries - 1:
                wait_time = 2 ** attempt  # æŒ‡æ•°é€€é¿
                print(f"è¿æ¥å¤±è´¥ï¼Œ{wait_time}s åé‡è¯•...")
                time.sleep(wait_time)
            else:
                print(f"{max_retries} æ¬¡å°è¯•åæ— æ³•è¿æ¥")
                raise
```

### æˆæœ¬ä¸å¤±è´¥æ£€æŸ¥

é€šè¿‡çŠ¶æ€åˆ¤æ–­å¤±è´¥ï¼Œå¹¶ä½¿ç”¨ `list_tasks()` è·å–ç”¨é‡ä¸æˆæœ¬åˆè®¡ï¼š

```python
from shannon import ShannonClient, TaskStatusEnum

client = ShannonClient()
handle = client.submit_task(query="Analyze data")
status = client.wait(handle.task_id)

# å¤±è´¥æ£€æŸ¥ï¼ˆTaskStatus è¿”å›çš„æ˜¯æšä¸¾ï¼‰
if status.status == TaskStatusEnum.FAILED:
    print(f"å¤±è´¥å¹¶å‡ºç°é”™è¯¯ï¼š{status.error_message}")

# ç”¨é‡ä¸æˆæœ¬ï¼ˆä»ä»»åŠ¡åˆ—è¡¨è¯»å–ï¼‰
tasks, _ = client.list_tasks(limit=50)
summary = next((t for t in tasks if t.task_id == handle.task_id), None)
usage = summary.total_token_usage if summary else None
if usage:
    print(f"tokens={usage.total_tokens} prompt={usage.prompt_tokens} completion={usage.completion_tokens} cost=${usage.cost_usd:.6f}")

# æ³¨æ„ï¼šTaskSummary.status æ˜¯å­—ç¬¦ä¸²
if summary and summary.status == "FAILED":
    print("åˆ—è¡¨æ‘˜è¦æŒ‡ç¤ºå¤±è´¥")
```

### è¶…æ—¶é”™è¯¯

å¤„ç†é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼š

```python
import asyncio
from shannon import AsyncShannonClient, TaskTimeoutError

async def with_timeout_handling():
    async with AsyncShannonClient() as client:
        try:
            # asyncio.TimeoutError æ¥è‡ª wait_for åŒ…è£…å™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰
            handle = await asyncio.wait_for(
                client.submit_task(query="å¤æ‚åˆ†æ"),
                timeout=10.0,
            )
            # TaskTimeoutError æ¥è‡ª Shannonï¼Œå¦‚æœä»»åŠ¡è¶…å‡ºäº†è‡ªå·±çš„è¶…æ—¶
            result = await asyncio.wait_for(client.wait(handle.task_id), timeout=60.0)
            return result

        except asyncio.TimeoutError:
            print("æ“ä½œè¶…æ—¶ï¼ˆå®¢æˆ·ç«¯ asyncio è¶…æ—¶ï¼‰")
            return None
        except TaskTimeoutError:
            print("ä»»åŠ¡è¶…æ—¶ï¼ˆShannon æŠ¥å‘Šè¶…æ—¶ï¼‰")
            return None
```

### é€Ÿç‡é™åˆ¶

ä¼˜é›…åœ°å¤„ç† API é€Ÿç‡é™åˆ¶ï¼š

```python
from shannon import ShannonClient, ConnectionError
import time

def handle_rate_limits(queries):
    client = ShannonClient()
    results = []

    for query in queries:
        backoff = 1
        while True:
            try:
                handle = client.submit_task(query=query)
                result = client.wait(handle.task_id)
                results.append(result)
                break  # æˆåŠŸï¼Œç§»åˆ°ä¸‹ä¸€ä¸ª

            except ConnectionError:
                # é€Ÿç‡é™åˆ¶æˆ–ç¬æ—¶ç½‘ç»œé”™è¯¯
                print(f"è§¦å‘é€Ÿç‡é™åˆ¶/æš‚æ—¶æ€§é”™è¯¯ï¼Œ{backoff}s åé‡è¯•â€¦")
                time.sleep(backoff)
                backoff = min(backoff * 2, 30)

    return results
```

<Note>
å¯¼å…¥è¯´æ˜ï¼š`from shannon import ConnectionError` æŒ‡çš„æ˜¯ SDK çš„å¼‚å¸¸ç±»å‹ï¼ˆä¸æ˜¯ Python å†…ç½®çš„ `ConnectionError`ï¼‰ã€‚é€Ÿç‡é™åˆ¶ä¸æ–­è·¯å™¨ç­‰é«˜çº§æ¨¡å¼å±äºå‚è€ƒå®ç°ï¼Œè¯·æ ¹æ®ç”Ÿäº§ç¯å¢ƒéªŒè¯ä¸è°ƒæ•´ã€‚
</Note>

## éªŒè¯é”™è¯¯

å¤„ç†æ— æ•ˆå‚æ•°ï¼š

```python
from shannon import ShannonClient, ValidationError

def validate_and_submit(query, session_id=None):
    client = ShannonClient()

    try:
        return client.submit_task(query=query, session_id=session_id)
    except ValidationError as e:
        print(f"æ— æ•ˆå‚æ•°ï¼š{e}")
        return None
```

## ä»»åŠ¡å¤±è´¥å¤„ç†

å¤„ç†ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼š

```python
from shannon import ShannonClient, TaskTimeoutError, TaskStatusEnum

def handle_task_failure(query):
    client = ShannonClient()

    try:
        handle = client.submit_task(query=query)
        status = client.wait(handle.task_id, timeout=120)

        if status.status == TaskStatusEnum.FAILED:
            print(f"ä»»åŠ¡å¤±è´¥ï¼š{status.error_message}")
            return None
        return status
    except TaskTimeoutError:
        print("ä»»åŠ¡è¶…æ—¶ï¼›è¯·è€ƒè™‘å¢åŠ è¶…æ—¶æˆ–ç®€åŒ–è¯·æ±‚ã€‚")
        return None
```

## è®°å½•é”™è¯¯

å®ç°å…¨é¢çš„é”™è¯¯æ—¥å¿—ï¼š

```python
import logging
from shannon import ShannonClient, ShannonError

# é…ç½®æ—¥å¿—è®°å½•
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger('shannon')

def logged_task_submission(query):
    client = ShannonClient()

    try:
        logger.info(f"æäº¤ä»»åŠ¡ï¼š{query[:50]}...")
        handle = client.submit_task(query=query)

        logger.info(f"ä»»åŠ¡å·²æäº¤ï¼štask_id={handle.task_id}")
        result = client.wait(handle.task_id)

        logger.info("ä»»åŠ¡æˆåŠŸå®Œæˆ")
        return result.result

    except ShannonError as e:
        logger.error(f"Shannon é”™è¯¯ï¼š{e}", exc_info=True)
        raise

    except Exception as e:
        logger.critical(f"æ„å¤–é”™è¯¯ï¼š{e}", exc_info=True)
        raise
```

## æ–­è·¯å™¨æ¨¡å¼

ä¸ºå¼¹æ€§å®ç°æ–­è·¯å™¨ï¼š

```python
class CircuitBreaker:
    def __init__(self, failure_threshold=5, reset_timeout=60):
        self.failure_count = 0
        self.failure_threshold = failure_threshold
        self.reset_timeout = reset_timeout
        self.last_failure_time = None
        self.state = "closed"  # closed, open, half-open

    def call(self, func, *args, **kwargs):
        if self.state == "open":
            if time.time() - self.last_failure_time > self.reset_timeout:
                self.state = "half-open"
            else:
                raise Exception("æ–­è·¯å™¨æ˜¯æ‰“å¼€çš„")

        try:
            result = func(*args, **kwargs)
            if self.state == "half-open":
                self.state = "closed"
                self.failure_count = 0
            return result

        except Exception as e:
            self.failure_count += 1
            self.last_failure_time = time.time()

            if self.failure_count >= self.failure_threshold:
                self.state = "open"

            raise

# ç”¨æ³•
breaker = CircuitBreaker()
client = ShannonClient()

try:
    result = breaker.call(
        client.submit_task,
        query="åˆ†ææ•°æ®"
    )
except Exception as e:
    print(f"æœåŠ¡ä¸å¯ç”¨ï¼š{e}")
```

## æœ€ä½³å®è·µ

1. **å§‹ç»ˆåœ¨æ³›å‹å¼‚å¸¸ä¹‹å‰æ•è·ç‰¹å®šå¼‚å¸¸**
2. **ä½¿ç”¨æŒ‡æ•°é€€é¿å®ç°é‡è¯•é€»è¾‘**
3. **è®°å½•é”™è¯¯**ä»¥ä¾›è°ƒè¯•å’Œç›‘æ§
4. **ä¸ºå…³é”®æ“ä½œæä¾›å›é€€é€‰é¡¹**
5. **è®¾ç½®åˆç†çš„è¶…æ—¶**ä»¥é¿å…æŒ‚èµ·
6. **åœ¨æäº¤å‰éªŒè¯è¾“å…¥**
7. **å¯¹å¤–éƒ¨ä¾èµ–é¡¹ä½¿ç”¨æ–­è·¯å™¨**

## åç»­æ­¥éª¤

<CardGroup cols={2}>
  <Card title="ç¤ºä¾‹" icon="code" href="/cn/sdk/python/examples">
    æŸ¥çœ‹é”™è¯¯å¤„ç†çš„å®é™…åº”ç”¨
  </Card>
  <Card title="å¼‚æ­¥ç”¨æ³•" icon="bolt" href="/cn/sdk/python/async-usage">
    å¼‚æ­¥é”™è¯¯æ¨¡å¼
  </Card>
</CardGroup>
## å®Œæ•´ç¤ºä¾‹ï¼šå¸¦é‡è¯•é€»è¾‘

```python
#!/usr/bin/env python3
"""å¸¦é‡è¯•é€»è¾‘çš„é”™è¯¯å¤„ç†ç¤ºä¾‹"""

import time
from shannon import ShannonClient, ConnectionError, TaskTimeoutError, ShannonError

def robust_task_submission(query: str, max_retries: int = 3):
    """
    ä½¿ç”¨é‡è¯•é€»è¾‘æäº¤ä»»åŠ¡ï¼Œå¹¶åŒ…å«å…¨é¢çš„é”™è¯¯å¤„ç†ã€‚

    å‚æ•°ï¼š
        query: ä»»åŠ¡æŸ¥è¯¢å†…å®¹
        max_retries: å¯é‡è¯•é”™è¯¯çš„æœ€å¤§é‡è¯•æ¬¡æ•°

    è¿”å›ï¼š
        TaskStatus å¯¹è±¡ï¼›è‹¥æ‰€æœ‰å°è¯•å‡å¤±è´¥åˆ™è¿”å› None
    """
    client = ShannonClient()

    for attempt in range(max_retries):
        try:
            print(f"\n[å°è¯• {attempt + 1}/{max_retries}] æ­£åœ¨æäº¤ä»»åŠ¡â€¦")
            handle = client.submit_task(query=query)
            print(f"âœ… å·²æäº¤ä»»åŠ¡ï¼š{handle.task_id}")
            print("â³ ç­‰å¾…ç»“æœï¼ˆ300s è¶…æ—¶ï¼‰â€¦")
            result = client.wait(handle.task_id, timeout=300)
            print("âœ… ä»»åŠ¡æˆåŠŸå®Œæˆ")
            return result

        except ConnectionError as e:
            wait_time = 2 ** attempt  # 1s, 2s, 4s
            print(f"âŒ è¿æ¥é”™è¯¯ï¼š{e}")
            if attempt < max_retries - 1:
                print(f"â³ {wait_time} ç§’åé‡è¯•â€¦")
                time.sleep(wait_time)
            else:
                print(f"âŒ å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆ{max_retries}ï¼‰ï¼Œæ”¾å¼ƒã€‚")
                raise

        except TaskTimeoutError as e:
            print(f"âŒ ä»»åŠ¡è¶…æ—¶ï¼š{e}")
            print("âš ï¸  è¶…è¿‡ 300 ç§’é™åˆ¶ï¼Œä¸å†é‡è¯•ã€‚")
            raise

        except ShannonError as e:
            print(f"âŒ Shannon API é”™è¯¯ï¼š{e}")
            print("âš ï¸  é‡åˆ° API é”™è¯¯ï¼Œä¸å†é‡è¯•ã€‚")
            raise

        except Exception as e:
            print(f"âŒ æœªé¢„æœŸé”™è¯¯ï¼š{type(e).__name__}: {e}")
            raise

    return None


def main():
    print("=" * 60)
    print("é”™è¯¯å¤„ç†ç¤ºä¾‹")
    print("=" * 60)

    print("\nğŸ“ ç¤ºä¾‹ 1ï¼šæ­£å¸¸æ‰§è¡Œ")
    print("-" * 60)
    try:
        result = robust_task_submission("2+2 ç­‰äºå¤šå°‘ï¼Ÿ")
        if result:
            print(f"\næœ€ç»ˆç»“æœï¼š{result.result}")
    except Exception as e:
        print(f"\nâš ï¸  å¤±è´¥ï¼š{e}")

    print("\n\nğŸ“ ç¤ºä¾‹ 2ï¼šè¶…æ—¶åœºæ™¯")
    print("-" * 60)
    print("æç¤ºï¼šæ­¤å¤„æ¼”ç¤ºè¶…æ—¶å¤„ç†")
    try:
        result = robust_task_submission(
            "åˆ†æä¸€ä¸ªå¤æ‚æ•°æ®é›†â€¦ï¼ˆæ¨¡æ‹Ÿè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡ï¼‰"
        )
        if result:
            print(f"\næœ€ç»ˆç»“æœï¼š{result.result}")
    except TaskTimeoutError:
        print("\nâš ï¸  ä»»åŠ¡è¶…æ—¶â€”â€”ä¸é‡è¯•ï¼ˆé¢„æœŸè¡Œä¸ºï¼‰")
    except Exception as e:
        print(f"\nâš ï¸  é”™è¯¯ï¼š{e}")

    print("\n\nğŸ“ ç¤ºä¾‹ 3ï¼šç®€å•çš„ try/except æ¨¡å¼")
    print("-" * 60)
    client = ShannonClient()
    try:
        handle = client.submit_task(query="æ³•å›½çš„é¦–éƒ½æ˜¯å“ªé‡Œï¼Ÿ")
        result = client.wait(handle.task_id)
        print(f"âœ… æˆåŠŸï¼š{result.result}")
    except ConnectionError:
        print("âŒ ç½‘ç»œé—®é¢˜â€”â€”è¯·æ£€æŸ¥ Shannon æœåŠ¡")
    except TaskTimeoutError:
        print("âŒ ä»»åŠ¡è€—æ—¶è¿‡é•¿")
    except ShannonError as e:
        print(f"âŒ API é”™è¯¯ï¼š{e}")
    except Exception as e:
        print(f"âŒ æœªé¢„æœŸé”™è¯¯ï¼š{e}")

    print("\n" + "=" * 60)
    print("âœ… é”™è¯¯å¤„ç†ç¤ºä¾‹å®Œæˆï¼")
    print("=" * 60)


if __name__ == "__main__":
    main()
```

è¿è¡Œæ–¹æ³•ï¼š

```bash
# ç¡®ä¿ Shannon å·²è¿è¡Œ
make dev

# è¿è¡Œç¤ºä¾‹
python3 error_handling.py
```

ä½•æ—¶ä½¿ç”¨é‡è¯•ï¼š

- ç½‘ç»œä¸ç¨³å®š
- ä¸´æ—¶æ€§æœåŠ¡é—®é¢˜
- å¯¹å¯é æ€§æœ‰è¦æ±‚çš„ç”Ÿäº§ç³»ç»Ÿ

ä¸å»ºè®®é‡è¯•ï¼š

- è¶…æ—¶ï¼ˆä»»åŠ¡æœ¬èº«è¿‡äºå¤æ‚/è€—æ—¶ï¼‰
- API é”™è¯¯ï¼ˆå‚æ•°æ— æ•ˆç­‰ï¼‰
- è®¤è¯å¤±è´¥
