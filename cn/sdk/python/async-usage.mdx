---
title: "异步/等待使用"
description: "使用 asyncio 与 Shannon Python SDK 进行并发操作"
---

<Note>
完整的异步文档即将推出。基本模式如下所示。
</Note>

## 概述

Shannon Python SDK 提供同步和异步客户端以实现最大灵活性。异步操作适用于：

- 并发任务提交
- 非阻塞事件流式传输
- 并行 API 调用
- 高吞吐量应用

## AsyncShannonClient

### 基本用法

```python
import asyncio
from shannon import AsyncShannonClient

async def main():
    async with AsyncShannonClient(http_endpoint="http://localhost:8080") as client:
        # 异步提交任务
        handle = await client.submit_task(
            query="Analyze this data",
            # 自动选择模式
        )

        # 获取结果
        result = await client.get_status(handle.workflow_id)
        print(result)

asyncio.run(main())
```

## 并发任务

同时提交多个任务：

```python
async def analyze_multiple():
    async with AsyncShannonClient() as client:
        # 并发提交任务
        tasks = [
            client.submit_task(query="Analyze dataset 1"),
            client.submit_task(query="Analyze dataset 2"),
            client.submit_task(query="Analyze dataset 3"),
        ]

        # 等待所有任务完成
        handles = await asyncio.gather(*tasks)

        # 获取所有结果
        results = await asyncio.gather(*[
            client.get_status(h.workflow_id)
            for h in handles
        ])

        return results
```

## 异步流式传输

非阻塞流式事件：

```python
async def stream():
    async with AsyncShannonClient() as client:
        handle = await client.submit_task(query="Complex analysis")

        # 异步流式传输事件
        async for event in client.stream(handle.workflow_id):
            print(f"[{event.type}] {event.message}")

            if event.type == "TASK_COMPLETED":
                return event.data.get('result')
```

## 超时处理

```python
async def with_timeout():
    async with AsyncShannonClient() as client:
        try:
            # 带超时的提交
            handle = await asyncio.wait_for(
                client.submit_task(query="Analyze data"),
                timeout=30.0
            )

            # 带超时等待完成
            result = await asyncio.wait_for(
                client.wait(handle.workflow_id),
                timeout=300.0
            )

        except asyncio.TimeoutError:
            print("Operation timed out")
```

## 后台任务

在执行其他工作时在后台运行任务：

```python
async def background_processing():
    async with AsyncShannonClient() as client:
        # 启动后台任务
        task = asyncio.create_task(
            client.submit_and_wait("Long running analysis")
        )

        # 执行其他工作
        await do_other_work()

        # 检查是否完成
        if not task.done():
            print("Still processing...")

        # 需要时等待结果
        result = await task
```

## 错误处理

```python
async def robust_submission():
    async with AsyncShannonClient() as client:
        try:
            handle = await client.submit_task(
                query="Analyze data",
                config={"retry": {"max_attempts": 3}}
            )
            result = await client.get_status(handle.workflow_id)

        except ConnectionError:
            print("Failed to connect to Shannon")
        except TimeoutError:
            print("Request timed out")
        except Exception as e:
            print(f"Error: {e}")
```

## 与 Web 框架集成

### FastAPI 示例

```python
from fastapi import FastAPI
from shannon import AsyncShannonClient

app = FastAPI()
client = AsyncShannonClient()

@app.post("/analyze")
async def analyze(query: str):
    handle = await client.submit_task(query=query)
    result = await client.get_status(handle.workflow_id)
    return {"result": result}
```

### aiohttp 示例

```python
from aiohttp import web
from shannon import AsyncShannonClient

async def analyze_handler(request):
    data = await request.json()

    async with AsyncShannonClient() as client:
        handle = await client.submit_task(query=data['query'])
        result = await client.get_status(handle.workflow_id)

    return web.json_response({'result': result})
```

## 最佳实践

1. **使用上下文管理器**（`async with`）以正确清理
2. **处理超时**用于长时间运行的操作
3. **实现重试逻辑**用于网络故障
4. **使用 gather()**进行并发操作
5. **流式传输事件**以获得实时更新

## 下一步

<CardGroup cols={2}>
  <Card title="示例" icon="code" href="/cn/sdk/python/examples">
    更多代码示例
  </Card>
  <Card title="错误处理" icon="shield" href="/cn/sdk/python/error-handling">
    健壮的错误处理
  </Card>
</CardGroup>
