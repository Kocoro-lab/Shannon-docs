<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 650">
  <defs>
    <style>
      .label { font: 500 10px 'SF Mono', 'Hiragino Sans', 'Noto Sans JP', sans-serif; fill: #666; text-anchor: middle; }
      .box-text { font: 600 11px 'SF Mono', 'Hiragino Sans', 'Noto Sans JP', sans-serif; fill: #1a1a1a; text-anchor: middle; dominant-baseline: middle; }
      .decision { font: 600 10px 'SF Mono', 'Hiragino Sans', 'Noto Sans JP', sans-serif; fill: #1a1a1a; text-anchor: middle; dominant-baseline: middle; }
      .group-title { font: 600 12px 'SF Mono', 'Hiragino Sans', 'Noto Sans JP', sans-serif; fill: #666; text-anchor: start; }
    </style>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#666"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="900" height="650" fill="#fff"/>

  <!-- Request Flow Group -->
  <rect x="50" y="50" width="800" height="490" fill="none" stroke="#ddd" stroke-width="1" rx="4"/>
  <text x="60" y="70" class="group-title">リクエストフロー / Request Flow</text>

  <!-- Request -->
  <rect x="350" y="100" width="140" height="50" fill="#e0f2fe" stroke="#1a1a1a" stroke-width="1.5" rx="2"/>
  <text x="420" y="118" class="box-text">完了リクエスト</text>
  <text x="420" y="133" class="label">Completion Request</text>

  <!-- KeyGen -->
  <rect x="350" y="180" width="140" height="50" fill="#fef3c7" stroke="#1a1a1a" stroke-width="1.5" rx="2"/>
  <text x="420" y="198" class="box-text">キャッシュキー生成</text>
  <text x="420" y="213" class="label">Generate Key</text>

  <!-- Check -->
  <path d="M 420 260 L 490 300 L 420 340 L 350 300 Z" fill="#dbeafe" stroke="#1a1a1a" stroke-width="1.5"/>
  <text x="420" y="293" class="decision">キャッシュ</text>
  <text x="420" y="307" class="decision">ヒット?</text>

  <!-- Return Cached -->
  <rect x="150" y="370" width="140" height="50" fill="#bbf7d0" stroke="#1a1a1a" stroke-width="1.5" rx="2"/>
  <text x="220" y="388" class="box-text">キャッシュ返却</text>
  <text x="220" y="403" class="label">Return Cached</text>

  <!-- Provider -->
  <rect x="550" y="370" width="140" height="50" fill="#4ECDC4" stroke="#1a1a1a" stroke-width="1.5" rx="2"/>
  <text x="620" y="388" class="box-text">LLMプロバイダー</text>
  <text x="620" y="403" class="label">LLM Provider</text>

  <!-- Validate -->
  <path d="M 620 450 L 690 490 L 620 530 L 550 490 Z" fill="#ffedd5" stroke="#1a1a1a" stroke-width="1.5"/>
  <text x="620" y="483" class="decision">有効な</text>
  <text x="620" y="497" class="decision">レスポンス?</text>

  <!-- Store -->
  <rect x="450" y="560" width="100" height="50" fill="#fde047" stroke="#1a1a1a" stroke-width="1.5" rx="2"/>
  <text x="500" y="578" class="box-text">保存</text>
  <text x="500" y="593" class="label">Store</text>

  <!-- Skip -->
  <rect x="700" y="560" width="100" height="50" fill="#fecaca" stroke="#1a1a1a" stroke-width="1.5" rx="2"/>
  <text x="750" y="578" class="box-text">スキップ</text>
  <text x="750" y="593" class="label">Skip</text>

  <!-- Return2 -->
  <rect x="550" y="560" width="100" height="50" fill="#d1fae5" stroke="#1a1a1a" stroke-width="1.5" rx="2"/>
  <text x="600" y="578" class="box-text">返却</text>
  <text x="600" y="593" class="label">Return</text>

  <!-- Cache Backend Group -->
  <rect x="50" y="250" width="220" height="120" fill="none" stroke="#ddd" stroke-width="1" rx="4"/>
  <text x="60" y="270" class="group-title">キャッシュバックエンド</text>

  <!-- Memory -->
  <ellipse cx="120" cy="320" rx="50" ry="30" fill="#bfdbfe" stroke="#1a1a1a" stroke-width="1.5"/>
  <text x="120" y="313" class="box-text">インメモリ</text>
  <text x="120" y="326" class="label">LRU</text>

  <!-- Redis -->
  <ellipse cx="200" cy="320" rx="40" ry="30" fill="#fde047" stroke="#1a1a1a" stroke-width="1.5"/>
  <text x="200" y="320" class="box-text">Redis</text>

  <!-- Arrows -->
  <line x1="420" y1="150" x2="420" y2="175" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="420" y1="230" x2="420" y2="255" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Yes -->
  <line x1="350" y1="300" x2="290" y2="370" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="310" y="330" class="label">はい / Yes</text>

  <!-- No -->
  <line x1="490" y1="300" x2="600" y2="365" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="560" y="330" class="label">いいえ / No</text>

  <line x1="620" y1="420" x2="620" y2="445" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Yes Valid -->
  <line x1="550" y1="490" x2="500" y2="555" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="520" y="520" class="label">はい / Yes</text>

  <!-- No Valid -->
  <line x1="690" y1="490" x2="750" y2="555" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="730" y="520" class="label">いいえ / No</text>

  <line x1="500" y1="610" x2="545" y2="610" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="750" y1="610" x2="655" y2="610" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Check to Cache -->
  <line x1="350" y1="300" x2="150" y2="320" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="350" y1="300" x2="210" y2="320" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Store to Cache -->
  <line x1="470" y1="570" x2="150" y2="350" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="480" y1="565" x2="220" y2="350" stroke="#666" stroke-width="1.5" marker-end="url(#arrow)"/>
</svg>
